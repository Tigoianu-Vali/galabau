<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GalaBau Victor</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #009432;        
            --brand-dark: #1b5e20;
            --dark: #2f3640;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --danger: #c23616;
            --warning: #f1c40f;
            --sunday-bg: #ffebee;
            --admin-bg: #2c3e50;
            --photo-btn: #2980b9;
            --mat-btn: #8e44ad;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: url('https://images.unsplash.com/photo-1558904541-efa843a96f01?q=80&w=1000&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            color: var(--dark); overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            text-align: center;
        }

        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: -1; }
        .app-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }

        .header-card {
            background: var(--glass); padding: 15px; border-radius: 20px;
            box-shadow: var(--shadow); margin-bottom: 15px;
            border-top: 5px solid var(--brand);
            display: flex; flex-direction: column; align-items: center;
        }
        .logo-img { height: 75px; margin-bottom: 5px; display: block; }
        .live-clock { font-size: 2.2rem; font-weight: 900; color: var(--dark); line-height: 1; margin-top: 5px;}
        .live-date { font-size: 0.9rem; font-weight: 700; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        .weather-card {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; padding: 15px 20px; border-radius: 18px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; box-shadow: var(--shadow);
        }
        .w-temp { font-size: 3rem; font-weight: 900; }
        .w-msg { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; text-align: left; }
        .w-sub { font-size: 0.8rem; opacity: 0.95; font-style: italic; text-align: left; }

        .avizier-section { margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .avizier-label { 
            background: var(--brand); color: white; padding: 8px 20px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 800; display: inline-block; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-transform: uppercase;
        }
        #teams-container { width: 100%; }
        .team-display-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            border-left: 6px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        .team-display-card.t1 { border-left-color: #e74c3c; } 
        .team-display-card.t2 { border-left-color: #3498db; } 
        .team-display-card.t3 { border-left-color: #f1c40f; }
        .team-display-card.t4 { border-left-color: #9b59b6; }
        .team-display-card.t5 { border-left-color: #1abc9c; }
        .team-display-card.t6 { border-left-color: #34495e; }

        .td-name { font-weight: 800; font-size: 0.95rem; color: var(--dark); }
        .td-loc { font-size: 0.85rem; color: #666; display: block; margin-top: 3px; }
        .td-time { font-weight: 700; color: var(--brand); font-size: 0.9rem; }

        .glass-panel { 
            background: var(--glass); border-radius: 24px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }
        
        .worker-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-top: 15px; width: 100%; }
        .worker-item {
            background: white; border: 2px solid transparent; border-radius: 16px;
            padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.1s;
            width: 30%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center;
        }
        .worker-item.selected {
            border-color: var(--brand); background: #e8f5e9; transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,148,50,0.2);
        }
        .w-emoji { font-size: 3rem; display: block; margin-bottom: 5px; line-height: 1; }
        .w-label { font-weight: 800; font-size: 0.9rem; }

        .site-select, .car-select, .km-input, .mat-input {
            width: 100%; padding: 12px; border-radius: 12px; border: 2px solid #ddd;
            font-size: 1rem; margin-bottom: 10px; background: white;
            color: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.05); box-sizing: border-box;
        }
        .driver-box {
            width: 100%; background: #f1f8e9; padding: 15px; border-radius: 15px;
            margin-top: 15px; text-align: left; border: 1px solid #c5e1a5; box-sizing: border-box;
        }
        .fuel-type-box { display: flex; gap: 10px; margin-top: 10px; width: 100%; }
        .fuel-btn { 
            flex: 1; padding: 15px; border-radius: 8px; border: 2px solid #ddd; 
            cursor: pointer; font-weight: bold; background: white; transition: 0.2s; 
            text-align: center;
        }
        .fuel-btn.diesel.selected { border-color: #333; background: #333; color: white; }
        .fuel-btn.benz.selected { border-color: #2ecc71; background: #2ecc71; color: white; }

        .loc-auto {
            background: white; border: 1px solid #ddd; border-radius: 12px; padding: 15px;
            margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; box-sizing: border-box;
        }
        .loc-txt { font-weight: 700; font-size: 0.9rem; color: #555; }

        .active-panel {
            background: var(--glass); border-radius: 30px; padding: 40px 20px;
            text-align: center; margin-top: 20px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; align-items: center;
        }
        .site-display-box {
            background: #e8f5e9;
            color: var(--brand-dark);
            padding: 20px;
            border-radius: 12px;
            font-weight: 800;
            margin: 20px 0;
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #c8e6c9;
            font-size: 1.1rem;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.5;
            text-align: center;
        }
        .timer-val { font-size: 4.5rem; font-weight: 900; color: var(--brand-dark); line-height: 1; font-variant-numeric: tabular-nums; margin-top: 10px;}
        .status-badge {
            background: #dcedc8; color: #1b5e20; padding: 6px 15px; border-radius: 20px;
            font-weight: 800; font-size: 0.85rem; display: inline-block; margin-bottom: 5px;
        }
        .status-badge.paused { background: #fff3cd; color: #f39c12; }

        .btn {
            width: 100%; padding: 20px; border: none; border-radius: 16px;
            font-size: 1.2rem; font-weight: 800; color: white; cursor: pointer;
            margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-start { background: var(--brand); }
        .btn-stop { background: var(--danger); }
        .btn-pause { background: var(--warning); color: #333; }
        .btn-mat { background: var(--mat-btn); color: white; }
        
        .btn-photo-label {
            width: 100%; padding: 15px; background: var(--photo-btn); border-radius: 12px;
            font-size: 1rem; font-weight: bold; color: white; cursor: pointer;
            margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;
            box-shadow: 0 4px 10px rgba(41, 128, 185, 0.4); transition: transform 0.1s; box-sizing: border-box;
        }
        .btn-photo-label:active { transform: scale(0.98); }
        .btn-pdf { background: #c0392b; color: white; margin-top: 10px; font-size: 0.9rem; padding: 12px; border-radius: 8px; width: 100%; border:none; cursor:pointer;}
        .btn-small-del { background: #c0392b; color: white; border:none; border-radius:5px; padding:2px 8px; font-size:0.7rem; cursor:pointer; }
        .btn-add { background: var(--brand); color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; width: 30%; font-weight:bold;}

        .mat-add-box {
            width: 100%; background: #f3e5f5; padding: 15px; border-radius: 15px;
            margin-top: 15px; text-align: left; border: 1px solid #e1bee7; box-sizing: border-box;
        }
        .mat-list-item {
            background: white; padding: 8px; border-radius: 8px; margin-top: 5px;
            font-size: 0.9rem; font-weight: bold; color: #4a148c; border: 1px solid #eee;
            display: flex; justify-content: space-between; align-items: center;
        }

        .admin-trigger {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8);
            color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; z-index: 100;
        }

        #admin-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ecf0f1; z-index: 200; overflow-y: auto; display: none; text-align: left;
        }
        .admin-header {
            background: var(--brand); color: white; padding: 20px;
            display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:10;
        }
        .admin-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .team-edit-row { display: grid; grid-template-columns: 1fr 1fr 80px; gap: 8px; margin-bottom: 10px; }
        .inp { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        .admin-list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; font-weight: 600;
        }

        #map { height: 350px; width: 100%; border-radius: 10px; border: 1px solid #ccc; margin-top: 15px; z-index: 1; }

        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .cal-head { font-size: 0.75rem; font-weight: 800; color: #7f8c8d; }
        .cal-day {
            aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.85rem; cursor: pointer; background: white; border: 1px solid #e0e0e0;
        }
        .cal-day.sunday { background: var(--sunday-bg); color: #c0392b; border: 1px solid #e6b0aa; }
        .cal-day.has-data { background: #b9f6ca; color: #1b5e20; border: 2px solid var(--brand); }
        .cal-day.error { border: 2px solid red; background: #ffebee; }
        .cal-day.today { border: 2px solid var(--dark); }
        .cal-day.selected { transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.2); border: 2px solid var(--brand); }

        .legend-box { display: flex; gap: 10px; margin-bottom: 10px; background: #f4f6f8; padding: 10px; border-radius: 8px; justify-content: center;}
        .legend-item { font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        .day-detail-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #eee;
        }
        .stat-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; font-weight: bold; color: white; margin-left: 5px; }
        .bg-green { background: #2ecc71; }
        .bg-yellow { background: #f1c40f; color: #333; }
        .bg-red { background: #e74c3c; }

        .stop-confirm-box {
            background: white; padding: 20px; border-radius: 15px; margin-top: 20px; width: 100%; box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #eee; display: flex; flex-direction: column; align-items: center;
        }

        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .hidden { display: none !important; }
        
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

    <div class="backdrop"></div>

    <div id="loader" class="loader">
        <img src="Galabau-Victor-Logo.png" style="width:100%; max-width:500px; height:auto; object-fit:contain;">
    </div>

    <div id="main-screen" class="app-container">
        
        <div class="header-card">
            <img src="Galabau-Victor-Logo.png" class="logo-img">
            <div class="live-clock" id="clock-display">--:--</div>
            <div class="live-date" id="date-display">-- ----- 2025</div>
        </div>

        <div class="weather-card">
            <div>
                <div class="w-msg" id="smart-greet">Salut!</div>
                <div class="w-sub" id="smart-sub">Se √ÆncarcƒÉ meteo...</div>
            </div>
            <div class="w-temp" id="w-temp">--¬∞</div>
        </div>

        <div class="avizier-section">
            <div class="avizier-label" id="avizier-label-text">üìã DISPOZI»öII VICTOR</div>
            <div id="teams-container"></div>
        </div>

        <div id="setup-panel" class="glass-panel">
            <h3 style="margin:0 0 15px 0; color:#333;">SelecteazƒÉ Numele:</h3>
            <div class="worker-grid" id="main-worker-list"></div>

            <div style="width:100%; margin-top:20px; text-align:left;">
                <label style="font-weight:bold; font-size:0.9rem; color:#555;">üìç SelecteazƒÉ »òantierul:</label>
                <select id="site-selector" class="site-select">
                    <option value="" disabled selected>-- Alege »òantier --</option>
                </select>
            </div>

            <div style="width:100%; margin-top:10px; text-align:left;">
                <label style="font-weight:bold; color:#555; display:flex; align-items:center; gap:10px;">
                    <input type="checkbox" id="driver-check" onchange="toggleDriverBox()" style="width:20px; height:20px;">
                    üöó Conduci azi?
                </label>
            </div>

            <div id="driver-details" class="driver-box hidden">
                <label style="font-weight:bold; font-size:0.8rem; color:#555;">Alege Ma»ôina:</label>
                <select id="car-selector" class="car-select">
                    <option value="" disabled selected>-- Alege Ma»ôina --</option>
                </select>
                <label style="font-weight:bold; font-size:0.8rem; color:#555;">Km la plecare:</label>
                <input type="number" id="km-start" class="km-input" placeholder="Ex: 125000">
            </div>
            <div class="loc-auto">
                <span style="font-size:1.5rem;">üì°</span>
                <div class="loc-txt" id="loc-status">Loca»õie AutomatƒÉ</div>
            </div>

            <button class="btn btn-start" onclick="initStart()">üöÄ START MUNCƒÇ</button>
        </div>

        <div id="active-panel" class="active-panel hidden">
            <h2 id="active-user" style="margin:0;">Angajat</h2>
            <p id="active-loc" style="color:#666; font-size:0.8rem;">Loca»õie GPS</p>
            
            <div style="margin:20px 0; width:100%;">
                <div id="status-badge" class="status-badge">ACTIV</div>
                <div class="timer-val" id="timer-val">0h 0m</div>
                <div class="site-display-box" id="active-site">»òantier</div>
                <p id="active-car" style="color:#2980b9; font-weight:bold; font-size:0.9rem; margin:0; display:none;"></p>
                <div id="pause-display" style="margin-top:10px; font-weight:600; color:#555;">PauzƒÉ totalƒÉ: 0m</div>
            </div>

            <div id="work-controls" style="width:100%">
                <button class="btn btn-mat" id="btn-mat" onclick="toggleMaterialBox()">üì¶ ADAUGƒÇ MATERIALE</button>
                
                <div id="material-box" class="mat-add-box hidden">
                    <label style="font-weight:bold; color:#555; font-size:0.8rem;">Ce material?</label>
                    <input type="text" id="mat-name" class="mat-input" placeholder="Ex: Ciment, Nisip, Borduri">
                    
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1">
                            <label style="font-weight:bold; color:#555; font-size:0.8rem;">Cantitate</label>
                            <input type="number" id="mat-qty" class="mat-input" placeholder="0">
                        </div>
                        <div style="flex:1">
                            <label style="font-weight:bold; color:#555; font-size:0.8rem;">Unitate</label>
                            <select id="mat-unit" class="mat-input">
                                <option value="Buc">Buc</option>
                                <option value="Saci">Saci</option>
                                <option value="m">Metri (m)</option>
                                <option value="mp">mp (m¬≤)</option>
                                <option value="mc">mc (m¬≥)</option>
                                <option value="kg">kg</option>
                                <option value="L">Litri</option>
                                <option value="Palet">Palet</option>
                                <option value="Rulou">Rulou</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn-add" style="width:100%; background:#8e44ad;" onclick="saveMaterial()">üíæ SalveazƒÉ Material</button>
                    <div id="active-mat-list" style="margin-top:10px;"></div>
                </div>

                <button class="btn btn-pause" id="btn-pause" onclick="togglePause()">‚òï PAUZƒÇ</button>
                <button class="btn btn-stop" onclick="showStopConfirm()">‚èπ STOP ZI</button>
            </div>

            <div id="stop-confirm-box" class="stop-confirm-box hidden">
                <h3 style="margin-top:0;">Raport Final Zi</h3>

                <div id="end-driver-section" class="hidden" style="width:100%; text-align:left; margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:10px;">
                   <div style="background:#e8f5e9; padding:10px; border-radius:8px;">
                        <div id="display-car-info" style="font-weight:bold; color:#2c3e50; margin-bottom:5px;"></div>
                        <div style="margin-top:10px;">
                             <label style="font-size:0.9rem; font-weight:bold; color:#2c3e50;">üèÅ Km la sosire:</label>
                             <input type="number" id="end-km-stop" class="km-input" placeholder="Ex: 125150" style="margin-top:5px;">
                        </div>
                   </div>
                </div>

                <div style="width:100%; text-align:left; margin-bottom:15px;">
                    <label style="font-weight:bold; display:flex; align-items:center; gap:5px;">
                        <input type="checkbox" id="end-fuel-check" onchange="toggleEndFuel()" style="width:20px; height:20px;">
                        ‚õΩ Ai alimentat?
                    </label>
                    <div id="end-fuel-box" class="hidden" style="margin-top:10px;">
                        <div class="fuel-type-box">
                            <button type="button" class="fuel-btn diesel" id="btn-diesel" onclick="selFuel('MotorinƒÉ', this)">MotorinƒÉ ‚ö´</button>
                            <button type="button" class="fuel-btn benz" id="btn-benz" onclick="selFuel('BenzinƒÉ', this)">BenzinƒÉ üü¢</button>
                        </div>
                        <label style="font-size:0.8rem; font-weight:bold; margin-top:5px; display:block;">C√¢»õi Litri?</label>
                        <input type="number" id="fuel-liters" class="km-input" placeholder="Litri (ex: 50)">
                    </div>
                </div>

                <input type="file" id="photo-input" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoUpload(this)">
                <label for="photo-input" class="btn-photo-label">üì∑ FƒÇ POZƒÇ</label>
                
                <div id="photo-status" style="font-size:0.8rem; color:#27ae60; margin-top:5px; display:none; font-weight:bold;">Imagine Ata»ôatƒÉ! ‚úÖ</div>
                <button class="btn btn-stop" style="background:#7f8c8d; margin-top:10px;" onclick="finalizeStop(false)">STOP (FƒÇRƒÇ POZƒÇ)</button>
            </div>
        </div>

        <div class="admin-trigger" onclick="openAdmin()">‚öôÔ∏è Admin</div>
    </div>

    <div id="admin-screen">
        <div class="admin-header">
            <span style="font-weight:900; letter-spacing:1px;">ADMINISTRA»öIE</span>
            <button onclick="closeAdmin()" style="background:none; border:none; color:white; font-size:1.5rem;">‚úï</button>
        </div>

        <div style="padding:20px;">
            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">üë• GestioneazƒÉ Echipa</h4>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="new-worker-name" class="inp" placeholder="Nume nou" style="width:70%;">
                    <button class="btn-add" onclick="addNewWorker()">AdaugƒÉ</button>
                </div>
                <div id="admin-worker-list-container"></div>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">üèóÔ∏è GestioneazƒÉ »òantiere</h4>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="new-site-name" class="inp" placeholder="Nume »òantier" style="width:70%;">
                    <button class="btn-add" onclick="addNewSite()">AdaugƒÉ</button>
                </div>
                <div id="admin-site-list-container"></div>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">üöó Gestiune FlotƒÉ</h4>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="new-car-plate" class="inp" placeholder="Nr. √énmatriculare (B-99-GLB)" style="width:70%;">
                    <button class="btn-add" onclick="addNewCar()">AdaugƒÉ</button>
                </div>
                <div id="admin-car-list-container"></div>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">üìù Organizare & Avizier</h4>
                <div style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
                    <label style="font-size:0.8rem; font-weight:bold;">Data Dispozi»õie (ex: 06 Dec):</label>
                    <input class="inp" type="text" id="avizier-date-input" placeholder="Scrie data...">
                </div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm1-n" placeholder="Echipa 1"><input class="inp" type="text" id="tm1-l" placeholder="Loca»õie"><input class="inp" type="text" id="tm1-t" placeholder="07:30"></div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm2-n" placeholder="Echipa 2"><input class="inp" type="text" id="tm2-l" placeholder="Loca»õie"><input class="inp" type="text" id="tm2-t" placeholder="Ora"></div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm3-n" placeholder="Echipa 3"><input class="inp" type="text" id="tm3-l" placeholder="Loca»õie"><input class="inp" type="text" id="tm3-t" placeholder="Ora"></div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm4-n" placeholder="Echipa 4"><input class="inp" type="text" id="tm4-l" placeholder="Loca»õie"><input class="inp" type="text" id="tm4-t" placeholder="Ora"></div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm5-n" placeholder="Echipa 5"><input class="inp" type="text" id="tm5-l" placeholder="Loca»õie"><input class="inp" type="text" id="tm5-t" placeholder="Ora"></div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm6-n" placeholder="Echipa 6"><input class="inp" type="text" id="tm6-l" placeholder="Loca»õie"><input class="inp" type="text" id="tm6-t" placeholder="Ora"></div>
                <button onclick="saveTeams()" style="width:100%; background:var(--brand); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold;">ActualizeazƒÉ</button>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 10px 0;">üó∫Ô∏è Pozi»õii Live</h4>
                <div id="map"></div>
                <button onclick="refreshMap()" style="width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; background:#f9f9f9; border-radius:8px;">üîÑ Actualizare</button>
            </div>

            <div class="admin-card">
                <div class="legend-box">
                    <div class="legend-item"><div class="dot bg-green"></div> MuncƒÉ</div>
                    <div class="legend-item"><div class="dot bg-yellow"></div> PauzƒÉ</div>
                    <div class="legend-item"><div class="dot bg-red"></div> Eroare</div>
                </div>

                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px;">
                    <span onclick="changeMonth(-1)" style="cursor:pointer; padding:5px;">‚óÄ</span>
                    <span id="cal-month">Luna</span>
                    <span onclick="changeMonth(1)" style="cursor:pointer; padding:5px;">‚ñ∂</span>
                </div>
                <div class="cal-grid">
                    <div class="cal-head">Lu</div><div class="cal-head">Ma</div><div class="cal-head">Mi</div>
                    <div class="cal-head">Jo</div><div class="cal-head">Vi</div><div class="cal-head">S√¢</div><div class="cal-head" style="color:var(--danger)">Du</div>
                </div>
                <div class="cal-grid" id="cal-body"></div>
                
                <div id="day-detail-box" style="margin-top:20px; border-top:2px solid #f4f4f4; padding-top:15px; display:none;">
                    <h4 id="detail-title" style="margin:0 0 10px 0; color:var(--brand);">Activitate</h4>
                    <div id="detail-list"></div>
                </div>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">üìä Raport Financiar</h4>
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleStats()" style="width:100%; background:var(--admin-bg); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold;">Vezi Sumar</button>
                    <button onclick="generateDetailedPDF()" class="btn-pdf">üìÑ DescarcƒÉ PDF</button>
                </div>
                <div id="stats-panel" class="hidden" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                    <div style="font-weight:bold; color:var(--brand); margin-bottom:5px;">PE ANGAJA»öI:</div>
                    <div id="stats-list"></div>
                    <div style="font-weight:bold; color:var(--brand); margin-top:15px; margin-bottom:5px;">PE »òANTIERE:</div>
                    <div id="site-stats-list"></div>
                    <div style="font-weight:bold; color:var(--brand); margin-top:15px; margin-bottom:5px;">PE MA»òINI (KM):</div>
                    <div id="car-stats-list"></div>
                    <div style="font-weight:bold; color:var(--brand); margin-top:15px; margin-bottom:5px;">COMBUSTIBIL:</div>
                    <div id="fuel-stats-list"></div>
                </div>
            </div>

        </div>
    </div>

    <img id="logo-for-pdf" src="Galabau-Victor-Logo.png" style="display:none;">

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCoWS4CDB-xATg3ZsWhuaBzVvjeCGrL4X4",
            authDomain: "galabau-victor.firebaseapp.com",
            projectId: "galabau-victor",
            storageBucket: "galabau-victor.firebasestorage.app",
            messagingSenderId: "505659442402",
            appId: "1:505659442402:web:65278af4b272fd3c618abb",
            measurementId: "G-5TT0XW4ZDY"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            db.enablePersistence().catch(()=>{});
            window.db = db;
        } catch(e) { console.log(e); }

        let app = { 
            user: null, site: null, 
            startT: 0, isPaused: false, pauseStartT: 0, totalPause: 0, 
            docId: null, locName: "GPS", photoBase64: null, 
            car: null, kmStart: 0, selFuelType: null, materials: [] 
        };
        let timerInt, mapInst, mapMarkers=[], viewDate=new Date();
        let watchID = null;

        function cleanText(str) {
            if(!str) return "";
            const map = {'ƒÉ':'a','√¢':'a','√Æ':'i','»ô':'s','»õ':'t','ƒÇ':'A','√Ç':'A','√é':'I','»ò':'S','»ö':'T'};
            return str.replace(/[ƒÉ√¢√Æ»ô»õƒÇ√Ç√é»ò»ö]/g, function(m) { return map[m]; });
        }
        
        function formatHuman(ms) { 
            let h = Math.floor(ms/3600000); 
            let m = Math.floor((ms%3600000)/60000); 
            return `${h}h ${m}m`; 
        }

        async function checkAndCloseOldShifts() {
            const yesterday = new Date(); yesterday.setHours(0,0,0,0);
            const snaps = await window.db.collection('galabau.final').where('status', 'in', ['activ', 'pauza']).where('start', '<', firebase.firestore.Timestamp.fromDate(yesterday)).get();
            if(!snaps.empty) {
                snaps.forEach(doc => {
                    const forceStop = new Date(doc.data().start.toDate()); forceStop.setHours(23, 59, 59);
                    window.db.collection('galabau.final').doc(doc.id).update({status: 'eroare_neinchis', stop: firebase.firestore.Timestamp.fromDate(forceStop), ore: 0});
                });
            }
        }

        window.onload = () => {
            initClock();
            loadTeams();
            loadWorkers();
            loadSites();
            loadCars(); 
            checkAndCloseOldShifts();
            
            // ATENTIE: Noua cheie de sesiune "vt_final"
            const saved = localStorage.getItem('vt_final');
            if(saved) {
                const s = JSON.parse(saved);
                const today = new Date().toLocaleDateString('ro-RO');
                const sessionDay = new Date(s.startT).toLocaleDateString('ro-RO');
                if(today !== sessionDay) forceClose(s);
                else { app = s; restoreUI(); }
            }
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 1500);
        };

        function initClock() {
            setInterval(()=>{
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'});
                const months = ["IANUARIE","FEBRUARIE","MARTIE","APRILIE","MAI","IUNIE","IULIE","AUGUST","SEPTEMBRIE","OCTOMBRIE","NOIEMBRIE","DECEMBRIE"];
                document.getElementById('date-display').innerText = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            }, 1000);

            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async p => {
                    try {
                        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`);
                        const d = await r.json();
                        const t = Math.round(d.current_weather.temperature);
                        document.getElementById('w-temp').innerText = t+"¬∞";
                        
                        const h = new Date().getHours();
                        let mainMsg = "Salut!";
                        let subMsg = "Vreme bunƒÉ.";
                        if(t < 5) subMsg = "E frig. √émbracƒÉ-te bine!"; else if(t > 28) subMsg = "CaniculƒÉ. HidrateazƒÉ-te!";
                        document.getElementById('smart-greet').innerText = mainMsg;
                        document.getElementById('smart-sub').innerText = subMsg;
                    } catch(e){}
                });
            }
        }

        // --- MANAGERS (NOILE COLECTII _final) ---
        async function loadWorkers() {
            const doc = await window.db.collection('settings').doc('workers_final').get();
            let workers = ["Sandu", "Nicu", "Vadim", "Sorin", "Fani", "Ovidiu"]; 
            if(doc.exists && doc.data().list) workers = doc.data().list;
            else window.db.collection('settings').doc('workers_final').set({list: workers});
            
            const grid = document.getElementById('main-worker-list');
            grid.innerHTML = "";
            workers.forEach(name => {
                grid.innerHTML += `<div class="worker-item" onclick="selectUser(this, '${name}')"><span class="w-emoji">üë∑‚Äç‚ôÇÔ∏è</span><span class="w-label">${name}</span></div>`;
            });

            const admList = document.getElementById('admin-worker-list-container');
            admList.innerHTML = "";
            workers.forEach(name => {
                admList.innerHTML += `<div class="admin-list-row"><span>üë∑‚Äç‚ôÇÔ∏è ${name}</span><button class="btn-small-del" onclick="deleteWorker('${name}')">»òterge</button></div>`;
            });
        }
        async function addNewWorker() {
            const name = document.getElementById('new-worker-name').value;
            if(!name) return;
            const doc = await window.db.collection('settings').doc('workers_final').get();
            let list = doc.exists ? doc.data().list : [];
            list.push(name);
            await window.db.collection('settings').doc('workers_final').set({list: list}, {merge:true});
            document.getElementById('new-worker-name').value="";
            loadWorkers();
        }
        async function deleteWorker(name) {
            if(!confirm("»òtergi?")) return;
            const doc = await window.db.collection('settings').doc('workers_final').get();
            let list = doc.data().list.filter(w => w !== name);
            await window.db.collection('settings').doc('workers_final').update({list: list});
            loadWorkers();
        }

        async function loadSites() {
            const doc = await window.db.collection('settings').doc('sites_final').get();
            let sites = [];
            if(doc.exists && doc.data().list) sites = doc.data().list;
            const sel = document.getElementById('site-selector');
            sel.innerHTML = `<option value="" disabled selected>-- Alege »òantier --</option>`;
            sites.forEach(s => { sel.innerHTML += `<option value="${s}">${s}</option>`; });
            const admList = document.getElementById('admin-site-list-container');
            admList.innerHTML = "";
            sites.forEach(s => { admList.innerHTML += `<div class="admin-list-row"><span>üèóÔ∏è ${s}</span><button class="btn-small-del" onclick="deleteSite('${s}')">»òterge</button></div>`; });
        }
        async function addNewSite() {
            const name = document.getElementById('new-site-name').value;
            if(!name) return;
            const doc = await window.db.collection('settings').doc('sites_final').get();
            let list = doc.exists ? doc.data().list : [];
            list.push(name);
            await window.db.collection('settings').doc('sites_final').set({list: list}, {merge:true});
            document.getElementById('new-site-name').value="";
            loadSites();
        }
        async function deleteSite(name) {
            if(!confirm("»òtergi?")) return;
            const doc = await window.db.collection('settings').doc('sites_final').get();
            let list = doc.data().list.filter(s => s !== name);
            await window.db.collection('settings').doc('sites_final').update({list: list});
            loadSites();
        }

        async function loadCars() {
            const doc = await window.db.collection('settings').doc('vehicles_final').get();
            let cars = [];
            if(doc.exists && doc.data().list) cars = doc.data().list;
            
            const sel = document.getElementById('car-selector');
            sel.innerHTML = `<option value="" disabled selected>-- Alege Ma»ôina --</option>`;
            cars.forEach(c => { sel.innerHTML += `<option value="${c}">${c}</option>`; });

            const selEnd = document.getElementById('end-car-selector');
            if(selEnd) {
                selEnd.innerHTML = `<option value="" disabled selected>-- Alege Ma»ôina --</option>`;
                cars.forEach(c => { selEnd.innerHTML += `<option value="${c}">${c}</option>`; });
            }

            const admList = document.getElementById('admin-car-list-container');
            admList.innerHTML = "";
            cars.forEach(c => {
                admList.innerHTML += `<div class="admin-list-row"><span>üöó ${c}</span><button class="btn-small-del" onclick="deleteCar('${c}')">»òterge</button></div>`;
            });
        }
        async function addNewCar() {
            const plate = document.getElementById('new-car-plate').value;
            if(!plate) return;
            const doc = await window.db.collection('settings').doc('vehicles_final').get();
            let list = doc.exists ? doc.data().list : [];
            list.push(plate);
            await window.db.collection('settings').doc('vehicles_final').set({list: list}, {merge:true});
            document.getElementById('new-car-plate').value="";
            loadCars();
        }
        async function deleteCar(plate) {
            if(!confirm("»òtergi?")) return;
            const doc = await window.db.collection('settings').doc('vehicles_final').get();
            let list = doc.data().list.filter(c => c !== plate);
            await window.db.collection('settings').doc('vehicles_final').update({list: list});
            loadCars();
        }

        // AVIZIER
        function loadTeams() {
            if(!window.db) return;
            window.db.collection('settings').doc('echipe_final').onSnapshot(d => {
                const container = document.getElementById('teams-container');
                container.innerHTML = "";
                if(d.exists) {
                    const data = d.data();
                    if(data.data_avizier) document.getElementById('avizier-label-text').innerText = `üìã DISPOZI»öII: ${data.data_avizier}`;
                    const teams = [data.t1, data.t2, data.t3, data.t4, data.t5, data.t6].filter(t => t && t.nume);
                    if(teams.length === 0) container.innerHTML = "<div style='text-align:center;color:#999'>Nicio dispozi»õie momentan.</div>";
                    teams.forEach((t, i) => {
                        container.innerHTML += `<div class="team-display-card t${i+1}"><div><div class="td-name">Echipa ${i+1}: ${t.nume}</div><div class="td-loc">üìç ${t.loc}</div></div><div class="td-time">üïí ${t.ora}</div></div>`;
                    });
                }
            });
        }
        function saveTeams() {
            const data = {
                data_avizier: document.getElementById('avizier-date-input').value,
                t1: { nume: document.getElementById('tm1-n').value, loc: document.getElementById('tm1-l').value, ora: document.getElementById('tm1-t').value },
                t2: { nume: document.getElementById('tm2-n').value, loc: document.getElementById('tm2-l').value, ora: document.getElementById('tm2-t').value },
                t3: { nume: document.getElementById('tm3-n').value, loc: document.getElementById('tm3-l').value, ora: document.getElementById('tm3-t').value },
                t4: { nume: document.getElementById('tm4-n').value, loc: document.getElementById('tm4-l').value, ora: document.getElementById('tm4-t').value },
                t5: { nume: document.getElementById('tm5-n').value, loc: document.getElementById('tm5-l').value, ora: document.getElementById('tm5-t').value },
                t6: { nume: document.getElementById('tm6-n').value, loc: document.getElementById('tm6-l').value, ora: document.getElementById('tm6-t').value }
            };
            window.db.collection('settings').doc('echipe_final').set(data, {merge:true});
            alert("‚úÖ Avizier actualizat!");
        }

        // WORKER FLOW
        function selectUser(el, name) {
            document.querySelectorAll('.worker-item').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected'); app.user = name;
        }

        function toggleDriverBox() {
            const check = document.getElementById('driver-check');
            const box = document.getElementById('driver-details');
            if(check.checked) box.classList.remove('hidden');
            else box.classList.add('hidden');
        }

        function toggleEndDriver() {
            const check = document.getElementById('end-driver-check');
            const box = document.getElementById('end-driver-box');
            if(check && box) {
                if(check.checked) box.classList.remove('hidden');
                else box.classList.add('hidden');
            }
        }

        function toggleEndFuel() {
            const check = document.getElementById('end-fuel-check');
            const box = document.getElementById('end-fuel-box');
            if(check.checked) box.classList.remove('hidden');
            else box.classList.add('hidden');
        }

        function selFuel(type, el) {
            app.selFuelType = type;
            document.querySelectorAll('.fuel-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        // --- MATERIALS ---
        function toggleMaterialBox() {
            const box = document.getElementById('material-box');
            box.classList.toggle('hidden');
        }

        async function saveMaterial() {
            const name = document.getElementById('mat-name').value;
            const qty = document.getElementById('mat-qty').value;
            const unit = document.getElementById('mat-unit').value;

            if(!name || !qty) return alert("CompleteazƒÉ numele »ôi cantitatea!");

            const newMat = { name: name, qty: parseFloat(qty), unit: unit };
            
            if(!app.materials) app.materials = [];
            app.materials.push(newMat);

            // Update in DB (ATENTIE: galabau.final)
            await window.db.collection('galabau.final').doc(app.docId).update({
                materials: firebase.firestore.FieldValue.arrayUnion(newMat)
            });

            // Clear inputs
            document.getElementById('mat-name').value = '';
            document.getElementById('mat-qty').value = '';
            
            saveLocal();
            renderActiveMaterials();
        }

        function renderActiveMaterials() {
            const list = document.getElementById('active-mat-list');
            list.innerHTML = "";
            if(app.materials && app.materials.length > 0) {
                app.materials.forEach(m => {
                    list.innerHTML += `<div class="mat-list-item"><span>${m.name}</span> <span>${m.qty} ${m.unit} ‚úÖ</span></div>`;
                });
            }
        }

        function initStart() {
            if(!app.user) return alert("SelecteazƒÉ numele!");
            const siteVal = document.getElementById('site-selector').value;
            if(!siteVal) return alert("SelecteazƒÉ »òantierul!");
            app.site = siteVal;

            const isDriver = document.getElementById('driver-check').checked;
            if(isDriver) {
                const car = document.getElementById('car-selector').value;
                const km = document.getElementById('km-start').value;
                if(!car || !km) return alert("SelecteazƒÉ Ma»ôina »ôi Km!");
                app.car = car;
                app.kmStart = parseInt(km);
            }

            document.getElementById('loc-status').innerText = "üì° Se cautƒÉ GPS...";
            if(!navigator.geolocation) return startShift("FƒÉrƒÉ GPS", 0, 0);

            watchID = navigator.geolocation.watchPosition(async (pos) => {
                if(app.docId) {
                    await window.db.collection('galabau.final').doc(app.docId).update({
                        lat: pos.coords.latitude,
                        lon: pos.coords.longitude,
                        lastUpdate: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            }, (e)=>{console.log(e)}, {enableHighAccuracy:true});

            navigator.geolocation.getCurrentPosition(async (pos) => {
                let loc = "Loca»õie GPS";
                try {
                    const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=ro`);
                    const d = await r.json();
                    loc = d.locality || d.city || "Zona RuralƒÉ";
                } catch(e){}
                startShift(loc, pos.coords.latitude, pos.coords.longitude);
            }, ()=>startShift("Eroare GPS", 0, 0), {enableHighAccuracy:true});
        }

        async function startShift(loc, lat, lon) {
            const now = Date.now();
            app.startT = now; app.locName = loc; app.totalPause = 0; app.isPaused = false; app.photoBase64 = null;
            app.materials = []; // Reset materials on start

            let data = {
                nume: app.user, santier: app.site, locatie: loc, lat: lat, lon: lon,
                start: firebase.firestore.Timestamp.fromMillis(now),
                status: 'activ', luna: new Date().getMonth()+1, an: new Date().getFullYear(), zi: new Date().getDate(),
                lastUpdate: firebase.firestore.FieldValue.serverTimestamp(),
                materials: []
            };
            if(app.car) {
                data.masina = app.car;
                data.kmStart = app.kmStart;
            }

            // ATENTIE: galabau.final
            const doc = await window.db.collection('galabau.final').add(data);
            app.docId = doc.id;
            saveLocal(); restoreUI();
        }

        function togglePause() {
            const now = Date.now();
            if(!app.isPaused) {
                app.isPaused = true; app.pauseStartT = now;
                window.db.collection('galabau.final').doc(app.docId).update({status: 'pauza', pauseStart: firebase.firestore.Timestamp.fromMillis(now)});
            } else {
                app.isPaused = false; app.totalPause += (now - app.pauseStartT); app.pauseStartT = 0;
                window.db.collection('galabau.final').doc(app.docId).update({status: 'activ', pauseStart: null});
            }
            saveLocal(); restoreUI();
        }

        function showStopConfirm() {
            document.getElementById('work-controls').classList.add('hidden');
            document.getElementById('stop-confirm-box').classList.remove('hidden');
            if(app.car) {
                document.getElementById('end-driver-section').classList.remove('hidden');
                document.getElementById('display-car-info').innerText = `üöó ${app.car} (Start: ${app.kmStart})`;
            }
        }

        function handlePhotoUpload(input) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800;
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        app.photoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('photo-status').style.display='block';
                        setTimeout(() => finalizeStop(true), 1500);
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        async function finalizeStop(hasPhoto) {
            let kmStopVal = 0;
            if(app.car) {
                const inp = document.getElementById('end-km-stop').value;
                if(!inp) return alert("Introdu Km la sosire!");
                kmStopVal = parseInt(inp);
                if(kmStopVal < app.kmStart) return alert("Km Stop < Start!");
            }

            const now = Date.now();
            let finalPause = app.totalPause;
            if(app.isPaused) finalPause += (now - app.pauseStartT);
            const hours = ((now - app.startT - finalPause) / 3600000).toFixed(2);

            let updateData = {
                stop: firebase.firestore.Timestamp.fromMillis(now),
                ore: parseFloat(hours), pauza_min: Math.round(finalPause/60000), status: 'finalizat'
            };
            if(hasPhoto && app.photoBase64) updateData.poza = app.photoBase64;
            
            if(app.car) {
                updateData.kmStop = kmStopVal;
                updateData.kmParcursi = kmStopVal - app.kmStart;
            }

            if(document.getElementById('end-fuel-check').checked) {
                updateData.fuelType = app.selFuelType || "Nedefinit";
                updateData.fuelLiters = parseFloat(document.getElementById('fuel-liters').value || 0);
            }

            await window.db.collection('galabau.final').doc(app.docId).update(updateData);
            if(watchID) navigator.geolocation.clearWatch(watchID);
            localStorage.removeItem('vt_final'); location.reload();
        }

        async function forceClose(s) {
            localStorage.removeItem('vt_final'); location.reload();
        }

        function restoreUI() {
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('active-panel').classList.remove('hidden');
            document.getElementById('active-user').innerText = app.user;
            document.getElementById('active-loc').innerText = "üìç " + app.locName;
            document.getElementById('active-site').innerText = "üèóÔ∏è " + (app.site || "»òantier");
            
            if(app.car) {
                const p = document.getElementById('active-car');
                p.style.display = 'block';
                p.innerText = `üöô ${app.car} (Start: ${app.kmStart})`;
            }

            const btn = document.getElementById('btn-pause');
            const badge = document.getElementById('status-badge');
            if(app.isPaused) {
                btn.innerText = "‚ñ∂ REIA MUNCA"; btn.className = "btn btn-start";
                badge.innerText = "√éN PAUZƒÇ"; badge.className = "status-badge paused";
            } else {
                btn.innerText = "‚òï PAUZƒÇ"; btn.className = "btn btn-pause";
                badge.innerText = "ACTIV"; badge.className = "status-badge";
            }
            
            // Restore materials list if any
            renderActiveMaterials();

            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(tick, 1000); tick();
        }

        function tick() {
            const now = Date.now();
            let wm = app.isPaused ? (app.pauseStartT - app.startT - app.totalPause) : (now - app.startT - app.totalPause);
            let pm = app.isPaused ? (app.totalPause + (now - app.pauseStartT)) : app.totalPause;
            document.getElementById('timer-val').innerText = formatHuman(wm);
            document.getElementById('pause-display').innerText = `PauzƒÉ totalƒÉ: ${Math.round(pm/60000)}m`;
        }

        function saveLocal() { localStorage.setItem('vt_final', JSON.stringify(app)); }

        // ADMIN
        function openAdmin() {
            if(prompt("Parola:")==="passat90") {
                document.getElementById('admin-screen').style.display='block';
                setTimeout(initMap, 500); renderCalendar();
                loadWorkers(); loadSites(); loadCars();
                checkAndCloseOldShifts();
            } else alert("Gre»ôit.");
        }
        function closeAdmin() { document.getElementById('admin-screen').style.display='none'; }

        function initMap() {
            if(!mapInst) {
                mapInst = L.map('map').setView([45.65, 25.60], 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInst);
            }
            setTimeout(() => mapInst.invalidateSize(), 300);
            refreshMap();
            setInterval(refreshMap, 10000);
        }
        function refreshMap() {
            mapMarkers.forEach(m => mapInst.removeLayer(m)); mapMarkers=[];
            
            // GROUP MARKERS
            let locations = {};

            window.db.collection('galabau.final').where('status','in',['activ','pauza']).get().then(snaps => {
                const group = new L.featureGroup();
                snaps.forEach(doc => {
                    const d = doc.data();
                    if(d.lat) {
                        // Grupare pe coordonate (rotunjite)
                        let key = d.lat.toFixed(3) + '_' + d.lon.toFixed(3);
                        if(!locations[key]) locations[key] = [];
                        locations[key].push(d);
                    }
                });

                Object.keys(locations).forEach(k => {
                    let people = locations[k];
                    // LISTA PE HARTA UNUL SUB ALTUL
                    let tooltipContent = people.map(p => `<b>${p.nume}</b>`).join('<br>');
                    let first = people[0];

                    const m = L.marker([first.lat, first.lon])
                            .bindTooltip(tooltipContent, {permanent:true, direction:'right', className:'map-label'})
                            .addTo(mapInst);
                    mapMarkers.push(m); group.addLayer(m);
                });

                if(mapMarkers.length>0) mapInst.fitBounds(group.getBounds().pad(0.2));
            });
        }

        function changeMonth(d) { viewDate.setMonth(viewDate.getMonth()+d); renderCalendar(); }
        
        async function renderCalendar() {
            const grid = document.getElementById('cal-body');
            grid.innerHTML = "Wait...";
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            const monthNames = ["IANUARIE","FEBRUARIE","MARTIE","APRILIE","MAI","IUNIE","IULIE","AUGUST","SEPTEMBRIE","OCTOMBRIE","NOIEMBRIE","DECEMBRIE"];
            document.getElementById('cal-month').innerText = `${monthNames[m]} ${y}`;

            const snaps = await window.db.collection('galabau.final').where('luna','==',m+1).where('an','==',y).get();
            let dataMap = {}, totals = {}, siteTotals = {}, carTotals = {}, fuelTotals = {};
            snaps.forEach(doc => {
                const d = doc.data();
                if(!dataMap[d.zi]) dataMap[d.zi] = [];
                dataMap[d.zi].push(d);
                if(d.ore) { 
                    if(!totals[d.nume]) totals[d.nume] = 0; totals[d.nume] += d.ore; 
                    let s = d.santier || "Nespecificat";
                    if(!siteTotals[s]) siteTotals[s] = 0; siteTotals[s] += d.ore;
                }
                if(d.masina && d.kmParcursi) {
                    if(!carTotals[d.masina]) carTotals[d.masina] = 0;
                    carTotals[d.masina] += d.kmParcursi;
                }
                if(d.fuelLiters) {
                    let ft = d.fuelType || "Altul";
                    if(!fuelTotals[ft]) fuelTotals[ft] = 0;
                    fuelTotals[ft] += d.fuelLiters;
                }
            });
            window.monthlyTotals = totals; window.siteTotals = siteTotals; window.carTotals = carTotals; window.fuelTotals = fuelTotals; window.monthData = dataMap;

            const daysInMonth = new Date(y, m+1, 0).getDate();
            const startDay = new Date(y, m, 1).getDay(); 
            const pad = startDay === 0 ? 6 : startDay - 1;

            grid.innerHTML = "";
            for(let i=0; i<pad; i++) grid.innerHTML += `<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const date = new Date(y, m, d);
                let cls = 'cal-day';
                let content = d;
                if(date.getDay() === 0) { cls += ' sunday'; content = `${d}`; }
                else if(dataMap[d]) {
                    const hasErr = dataMap[d].some(x=>x.status==='eroare_neinchis');
                    cls += hasErr ? ' error' : ' has-data';
                }
                if(d===new Date().getDate() && m===new Date().getMonth()) cls += ' today';
                grid.innerHTML += `<div class="${cls}" onclick="showDetails(this, ${d})">${content}</div>`;
            }
        }

        function showDetails(el, d) {
            document.querySelectorAll('.cal-day').forEach(c=>c.classList.remove('selected'));
            el.classList.add('selected');
            const box = document.getElementById('day-detail-box');
            const list = document.getElementById('detail-list');
            box.style.display = 'block';
            
            const monthNames = ["IANUARIE","FEBRUARIE","MARTIE","APRILIE","MAI","IUNIE","IULIE","AUGUST","SEPTEMBRIE","OCTOMBRIE","NOIEMBRIE","DECEMBRIE"];
            document.getElementById('detail-title').innerText = `Activitate: ${d} ${monthNames[viewDate.getMonth()]}`;
            
            const checkDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
            if(checkDate.getDay() === 0) { list.innerHTML = "<div style='color:#c0392b; font-weight:bold; text-align:center;'>O zi liberƒÉ, doar pentru grƒÉtar! üçñ</div>"; return; }

            const data = window.monthData[d];
            if(!data) { list.innerHTML = "FƒÉrƒÉ activitate."; return; }

            list.innerHTML = "";
            data.forEach(item => {
                let st = item.status==='activ' ? 'Munce»ôte' : (item.status==='pauza' ? 'PauzƒÉ' : formatHuman(item.ore*3600000));
                let colorClass = item.status==='activ' ? 'bg-green' : (item.status==='pauza' ? 'bg-yellow' : 'bg-green');
                if(item.status==='eroare_neinchis') { st="NE√éNCHIS"; colorClass='bg-red'; }
                
                // LIVE TIME CALC IN LIST
                if(item.status === 'activ' || item.status === 'pauza') {
                    let ms = 0;
                    if(item.status==='activ') ms = Date.now() - item.start.toDate().getTime(); 
                    if(item.status==='pauza' && item.pauseStart) ms = Date.now() - item.pauseStart.toDate().getTime();
                    let h = Math.floor(ms/3600000);
                    let m = Math.floor((ms%3600000)/60000);
                    st += ` (${h}h ${m}m)`;
                }

                let pauzaText = "";
                if(item.pauza_min) {
                    pauzaText = `<span class="stat-badge bg-yellow" style="margin-right:5px;">‚òï ${item.pauza_min}m</span>`;
                }

                let carInfo = item.masina ? `<br><span style="font-size:0.8rem; color:#d35400;">üöó ${item.masina} (${item.kmParcursi||0} km)</span>` : '';
                let fuelInfo = item.fuelLiters ? `<br><span style="font-size:0.8rem; color:#27ae60;">‚õΩ ${item.fuelLiters}L (${item.fuelType})</span>` : '';
                let photoHtml = item.poza ? `<br><a href="${item.poza}" download="poza.jpg" style="font-size:0.7rem; color:blue">üì∑ Vezi PozƒÉ</a>` : '';
                
                let matHtml = "";
                if(item.materials && item.materials.length > 0) {
                    matHtml = `<br><span style="font-size:0.8rem; color:#8e44ad; font-weight:bold;">üì¶ Materiale:</span>`;
                    item.materials.forEach(m => {
                        matHtml += `<br><span style="font-size:0.8rem; color:#555;">- ${m.name}: ${m.qty} ${m.unit}</span>`;
                    });
                }

                list.innerHTML += `
                    <div class="day-detail-item">
                        <div><strong>${cleanText(item.nume)}</strong> <small>(${cleanText(item.santier)||'?'})</small>${carInfo}${fuelInfo}${matHtml}<br><small style="color:#777">${cleanText(item.locatie)}</small>${photoHtml}</div>
                        <div style="text-align:right">
                            ${pauzaText}
                            <span class="stat-badge ${colorClass}">${st}</span>
                        </div>
                    </div>`;
            });
        }

        function toggleStats() {
            const panel = document.getElementById('stats-panel');
            const list = document.getElementById('stats-list');
            const siteList = document.getElementById('site-stats-list');
            const carList = document.getElementById('car-stats-list');
            const fuelList = document.getElementById('fuel-stats-list');
            panel.classList.toggle('hidden');
            
            if(!panel.classList.contains('hidden')) {
                // Workers
                list.innerHTML = "";
                const sortedW = Object.keys(window.monthlyTotals || {}).sort((a,b) => window.monthlyTotals[b] - window.monthlyTotals[a]);
                sortedW.forEach(n => {
                    list.innerHTML += `<div style="padding:5px 0; border-bottom:1px dashed #ccc; display:flex; justify-content:space-between;"><b>${cleanText(n)}</b> <span>${formatHuman(window.monthlyTotals[n]*3600000)}</span></div>`;
                });
                // Sites
                siteList.innerHTML = "";
                const sortedS = Object.keys(window.siteTotals || {}).sort((a,b) => window.siteTotals[b] - window.siteTotals[a]);
                sortedS.forEach(s => {
                    siteList.innerHTML += `<div style="padding:5px 0; border-bottom:1px dashed #ccc; display:flex; justify-content:space-between;"><b>${cleanText(s)}</b> <span>${formatHuman(window.siteTotals[s]*3600000)}</span></div>`;
                });
                // Cars
                carList.innerHTML = "";
                const sortedC = Object.keys(window.carTotals || {}).sort((a,b) => window.carTotals[b] - window.carTotals[a]);
                sortedC.forEach(c => {
                    carList.innerHTML += `<div style="padding:5px 0; border-bottom:1px dashed #ccc; display:flex; justify-content:space-between;"><b>${c}</b> <span>${window.carTotals[c]} km</span></div>`;
                });
                // Fuel
                fuelList.innerHTML = "";
                Object.keys(window.fuelTotals || {}).forEach(t => {
                    fuelList.innerHTML += `<div style="padding:5px 0; border-bottom:1px dashed #ccc; display:flex; justify-content:space-between;"><b>${t}</b> <span>${window.fuelTotals[t]} L</span></div>`;
                });
            }
        }
        
        async function generateDetailedPDF() {
            if(!window.jspdf) return alert("Eroare PDF");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const monthName = document.getElementById('cal-month').innerText;
            
            const logo = document.getElementById('logo-for-pdf');
            if(logo && logo.src) {
                try {
                    const canvas = document.createElement("canvas");
                    canvas.width = logo.naturalWidth;
                    canvas.height = logo.naturalHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(logo, 0, 0);
                    const logoData = canvas.toDataURL("image/png");
                    doc.addImage(logoData, 'PNG', 90, 10, 30, 30 * (logo.naturalHeight/logo.naturalWidth)); 
                } catch(e){}
            }

            doc.setFontSize(18); doc.setTextColor(0, 148, 50);
            doc.text(`RAPORT LUNAR - ${monthName}`, 105, 50, { align: 'center' });
            doc.setFontSize(12); doc.setTextColor(0,0,0);
            doc.text("GalaBau Victor", 105, 57, { align: 'center' });
            
            let yPos = 70;

            const y = viewDate.getFullYear();
            const m = viewDate.getMonth() + 1;
            const snaps = await window.db.collection('galabau.final').where('luna','==',m).where('an','==',y).get();
            
            if(snaps.empty) return alert("Nu sunt date.");

            let rawDocs = [];
            snaps.forEach(doc => rawDocs.push(doc.data()));
            rawDocs.sort((a, b) => a.start.seconds - b.start.seconds);

            let report = {}, materialReport = {}, siteReport = {}, carReport = {}, carLogs = {}, fuelDiesel=[], fuelBenz=[];
            
            rawDocs.forEach(d => {
                if(!report[d.nume]) report[d.nume] = [];
                const start = d.start.toDate().toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'});
                const end = d.stop ? d.stop.toDate().toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'}) : "Activ";
                let s = d.santier || "-";
                let car = d.masina ? `${d.masina} (${d.kmParcursi||0}km)` : "-";
                
                // --- SEPARATE MATERIAL LOGIC ---
                if(d.materials && d.materials.length > 0) {
                    if(!materialReport[d.nume]) materialReport[d.nume] = [];
                    d.materials.forEach(m => {
                        materialReport[d.nume].push([
                            `${d.zi}/${d.luna}`,
                            cleanText(s),
                            cleanText(m.name),
                            m.qty,
                            m.unit
                        ]);
                    });
                }

                let hoursVal = d.ore || 0;
                
                report[d.nume].push({
                    row: [`${d.zi}/${d.luna}`, cleanText(s), car, cleanText(d.locatie), `${start}-${end}`, formatHuman(hoursVal*3600000)],
                    val: hoursVal
                });
                
                if(d.ore) {
                    let siteNameClean = d.santier || "Nespecificat";
                    if(!siteReport[siteNameClean]) siteReport[siteNameClean] = 0; 
                    siteReport[siteNameClean] += d.ore;
                }
                
                if(d.masina && d.kmStop) {
                    if(!carLogs[d.masina]) carLogs[d.masina] = [];
                    carLogs[d.masina].push([
                       `${d.zi}/${d.luna}`,
                       cleanText(d.nume),
                       d.kmStart,
                       d.kmStop,
                       (d.kmStop - d.kmStart) + " km"
                    ]);
                    
                    if(!carReport[d.masina]) carReport[d.masina] = 0; carReport[d.masina] += d.kmParcursi;
                }

                if(d.fuelLiters) {
                    let row = [`${d.zi}/${d.luna}`, cleanText(d.nume), d.fuelLiters + " L"];
                    if(d.fuelType === 'MotorinƒÉ') fuelDiesel.push(row);
                    else fuelBenz.push(row);
                }
            });

            // TABLE 1: Angajati (VERDE)
            Object.keys(report).forEach(name => {
                if(yPos > 250) { doc.addPage(); yPos = 20; }
                doc.setFontSize(14); doc.setTextColor(0, 148, 50);
                doc.text(`Angajat: ${cleanText(name)}`, 14, yPos);
                yPos += 6;
                let rows = report[name].map(r => r.row);
                let totalH = report[name].reduce((acc, curr) => acc + curr.val, 0);
                
                // Main Hours Table
                doc.autoTable({
                    startY: yPos,
                    head: [['Data', 'Santier', 'Masina', 'Locatie', 'Interval', 'Ore']],
                    body: rows,
                    theme: 'grid',
                    styles: { halign: 'center', fontSize: 8 },
                    headStyles: { halign: 'center', fillColor: [46, 204, 113] }, // VERDE
                    foot: [['', '', '', '', 'TOTAL:', formatHuman(totalH * 3600000)]],
                    footStyles: { fillColor: [240, 240, 240], textColor: [0,0,0], fontStyle: 'bold', halign: 'center' }
                });
                yPos = doc.lastAutoTable.finalY;

                // --- MATERIAL TABLE FOR THIS WORKER (If any) ---
                if(materialReport[name] && materialReport[name].length > 0) {
                    yPos += 8; // small gap
                    doc.setFontSize(10); doc.setTextColor(142, 68, 173); // Purple
                    doc.text("Materiale Utilizate:", 14, yPos);
                    yPos += 4;

                    doc.autoTable({
                        startY: yPos,
                        head: [['Data', 'Santier', 'Material', 'Cant.', 'Unit.']],
                        body: materialReport[name],
                        theme: 'grid',
                        styles: { halign: 'center', fontSize: 8 },
                        headStyles: { halign: 'center', fillColor: [142, 68, 173] } // Purple
                    });
                    yPos = doc.lastAutoTable.finalY;
                }

                yPos += 15; // Gap before next worker
            });

            // TABLE 2: SANTIERE (ALBASTRU)
            doc.addPage();
            yPos = 20;
            doc.setFontSize(16); doc.setTextColor(52, 152, 219);
            doc.text("TOTAL ORE PER SANTIER", 105, yPos, { align: 'center' });
            yPos += 10;
            let siteRows = [];
            Object.keys(siteReport).forEach(s => {
                siteRows.push([cleanText(s), formatHuman(siteReport[s]*3600000)]);
            });
            doc.autoTable({
                startY: yPos,
                head: [['Nume Santier', 'Total Ore']],
                body: siteRows,
                theme: 'striped',
                styles: { halign: 'center' },
                headStyles: { fillColor: [52, 152, 219], halign: 'center' } // ALBASTRU
            });

            // TABLE 3: FLOTA (PORTOCALIU)
            if(Object.keys(carLogs).length > 0) {
                doc.addPage();
                yPos = 20;
                doc.setFontSize(16); doc.setTextColor(230, 126, 34);
                doc.text("JURNAL FLOTA AUTO (Fahrtenbuch)", 105, yPos, { align: 'center' });
                yPos += 15;

                Object.keys(carLogs).forEach(plate => {
                    if(yPos > 250) { doc.addPage(); yPos = 20; }
                    doc.setFontSize(12); doc.setTextColor(0,0,0);
                    doc.text(`Masina: ${plate}`, 14, yPos);
                    yPos += 5;
                    doc.autoTable({
                        startY: yPos,
                        head: [['Data', 'Sofer', 'Km Start', 'Km Stop', 'Distanta']],
                        body: carLogs[plate],
                        theme: 'grid',
                        styles: { halign: 'center' },
                        headStyles: { fillColor: [230, 126, 34], halign: 'center' }, // PORTOCALIU
                        foot: [['', '', '', 'TOTAL:', carReport[plate] + ' km']],
                        footStyles: { fillColor: [250, 229, 211], textColor: [0,0,0], fontStyle: 'bold', halign: 'center' }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                });
            }

            // TABLE 4: COMBUSTIBIL (ROSU/VERDE)
            if(fuelDiesel.length > 0 || fuelBenz.length > 0) {
                doc.addPage();
                yPos = 20;
                doc.setFontSize(16); doc.setTextColor(192, 57, 43);
                doc.text("RAPORT COMBUSTIBIL", 105, yPos, { align: 'center' });
                yPos += 15;

                if(fuelDiesel.length > 0) {
                    doc.setFontSize(12); doc.setTextColor(0,0,0);
                    doc.text("MOTORINA (DIESEL)", 14, yPos);
                    yPos += 5;
                    let totD = fuelDiesel.reduce((acc, r) => acc + parseFloat(r[2]), 0);
                    doc.autoTable({
                        startY: yPos,
                        head: [['Data', 'Angajat', 'Litri']],
                        body: fuelDiesel,
                        theme: 'grid',
                        headStyles: { fillColor: [50, 50, 50], halign: 'center' }, // NEGRU
                        foot: [['', 'TOTAL:', totD + " L"]],
                        footStyles: { fillColor: [200, 200, 200], textColor: [0,0,0], fontStyle: 'bold', halign: 'center' }
                    });
                    yPos = doc.lastAutoTable.finalY + 15;
                }

                if(fuelBenz.length > 0) {
                    doc.setFontSize(12); doc.setTextColor(0,0,0);
                    doc.text("BENZINA (GASOLINE)", 14, yPos);
                    yPos += 5;
                    let totB = fuelBenz.reduce((acc, r) => acc + parseFloat(r[2]), 0);
                    doc.autoTable({
                        startY: yPos,
                        head: [['Data', 'Angajat', 'Litri']],
                        body: fuelBenz,
                        theme: 'grid',
                        headStyles: { fillColor: [46, 204, 113], halign: 'center' }, // VERDE
                        foot: [['', 'TOTAL:', totB + " L"]],
                        footStyles: { fillColor: [200, 255, 200], textColor: [0,0,0], fontStyle: 'bold', halign: 'center' }
                    });
                }
            }

            doc.save(`Raport_GalaBau_${monthName}.pdf`);
        }
    </script>
</body>
</html>
