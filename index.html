<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>GalaBau Victor OS</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">
    <link rel="shortcut icon" href="icon.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --brand: #009432;       
            --brand-dark: #1b5e20;
            --dark: #2f3640;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.98);
            --shadow: 0 5px 15px rgba(0,0,0,0.1);
            --danger: #c23616;
            --warning: #f1c40f;
            --sunday-bg: #ffebee;
            --admin-bg: #2c3e50;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: url('https://images.unsplash.com/photo-1558904541-efa843a96f01?q=80&w=1000&auto=format&fit=crop') no-repeat center center fixed;
            background-size: cover;
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            color: var(--dark); overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            text-align: center;
        }

        .backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(4px); z-index: -1; }
        .app-container { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }

        /* HEADER */
        .header-card {
            background: var(--glass); padding: 15px; border-radius: 20px;
            box-shadow: var(--shadow); margin-bottom: 15px;
            border-top: 5px solid var(--brand);
            display: flex; flex-direction: column; align-items: center;
        }
        .logo-img { height: 75px; margin-bottom: 5px; display: block; }
        .live-clock { font-size: 2.2rem; font-weight: 900; color: var(--dark); line-height: 1; }
        .live-date { font-size: 0.9rem; font-weight: 700; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; margin-top: 5px; }

        /* VREME */
        .weather-card {
            background: linear-gradient(135deg, #11998e, #38ef7d);
            color: white; padding: 15px 20px; border-radius: 18px;
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; box-shadow: var(--shadow);
        }
        .w-temp { font-size: 3rem; font-weight: 900; }
        .w-msg { font-size: 1.1rem; font-weight: 700; margin-bottom: 5px; text-align: left; }
        .w-sub { font-size: 0.8rem; opacity: 0.95; font-style: italic; text-align: left; }

        /* AVIZIER */
        .avizier-section { margin-bottom: 25px; display: flex; flex-direction: column; align-items: center; }
        .avizier-label { 
            background: var(--brand); color: white; padding: 8px 20px; border-radius: 20px;
            font-size: 0.85rem; font-weight: 800; display: inline-block; margin-bottom: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); text-transform: uppercase;
        }
        #teams-container { width: 100%; }
        .team-display-card {
            background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px;
            border-left: 6px solid #ccc; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center; text-align: left;
        }
        .team-display-card.t1 { border-left-color: #e74c3c; } 
        .team-display-card.t2 { border-left-color: #3498db; } 
        .team-display-card.t3 { border-left-color: #f1c40f; }
        .td-name { font-weight: 800; font-size: 0.95rem; color: var(--dark); }
        .td-loc { font-size: 0.85rem; color: #666; display: block; margin-top: 3px; }
        .td-time { font-weight: 700; color: var(--brand); font-size: 0.9rem; }

        /* PANELS */
        .glass-panel { 
            background: var(--glass); border-radius: 24px; padding: 20px; box-shadow: var(--shadow); margin-bottom: 20px; 
            display: flex; flex-direction: column; align-items: center;
        }
        
        /* WORKER GRID - SIMETRIC */
        .worker-grid { 
            display: flex; flex-wrap: wrap; justify-content: center; 
            gap: 10px; margin-top: 15px; width: 100%;
        }
        .worker-item {
            background: white; border: 2px solid transparent; border-radius: 16px;
            padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.1s;
            width: 30%; box-sizing: border-box; display: flex; flex-direction: column; align-items: center;
        }
        .worker-item.selected {
            border-color: var(--brand); background: #e8f5e9; transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0,148,50,0.2);
        }
        .w-emoji { font-size: 3rem; display: block; margin-bottom: 5px; line-height: 1; }
        .w-label { font-weight: 800; font-size: 0.9rem; }

        /* SITE SELECTOR */
        .site-select {
            width: 100%; padding: 15px; border-radius: 12px; border: 2px solid #ddd;
            font-size: 1rem; font-weight: bold; margin-bottom: 15px; background: white;
            color: var(--dark); box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        /* LOCATIE */
        .loc-auto {
            background: white; border: 1px solid #ddd; border-radius: 12px; padding: 15px;
            margin-top: 5px; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; box-sizing: border-box;
        }
        .loc-txt { font-weight: 700; font-size: 0.9rem; color: #555; }

        /* ACTIVE TIMER */
        .active-panel {
            background: var(--glass); border-radius: 30px; padding: 40px 20px;
            text-align: center; margin-top: 20px; box-shadow: var(--shadow);
            display: flex; flex-direction: column; align-items: center;
        }
        .timer-val { font-size: 4.5rem; font-weight: 900; color: var(--brand-dark); line-height: 1; font-variant-numeric: tabular-nums; }
        .status-badge {
            background: #dcedc8; color: #1b5e20; padding: 6px 15px; border-radius: 20px;
            font-weight: 800; font-size: 0.85rem; display: inline-block; margin-bottom: 15px;
        }
        .status-badge.paused { background: #fff3cd; color: #f39c12; }

        /* BUTOANE */
        .btn {
            width: 100%; padding: 20px; border: none; border-radius: 16px;
            font-size: 1.2rem; font-weight: 800; color: white; cursor: pointer;
            margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            display: flex; justify-content: center; align-items: center;
        }
        .btn-start { background: var(--brand); }
        .btn-stop { background: var(--danger); }
        .btn-pause { background: var(--warning); color: #333; }
        .btn-photo { background: white; color: #333; border: 2px dashed #ccc; font-size: 0.9rem; padding: 12px; display:flex; align-items:center; justify-content:center; gap:10px; border-radius: 12px; width: 100%; margin-top: 10px; }
        .btn-pdf { background: #c0392b; color: white; margin-top: 10px; font-size: 0.9rem; padding: 12px; border-radius: 8px; width: 100%; border:none; cursor:pointer;}
        .btn-small-del { background: #c0392b; color: white; border:none; border-radius:5px; padding:2px 8px; font-size:0.7rem; cursor:pointer; }
        .btn-add { background: var(--brand); color: white; padding: 10px; border: none; border-radius: 8px; cursor: pointer; width: 30%; font-weight:bold;}

        .admin-trigger {
            position: fixed; bottom: 20px; right: 20px; background: rgba(0,0,0,0.8);
            color: white; padding: 8px 15px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; z-index: 100;
        }

        /* ADMIN PANEL */
        #admin-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ecf0f1; z-index: 200; overflow-y: auto; display: none; text-align: left;
        }
        .admin-header {
            background: var(--brand); color: white; padding: 20px;
            display: flex; justify-content: space-between; align-items: center; position: sticky; top:0; z-index:10;
        }
        .admin-card { background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .team-edit-row { display: grid; grid-template-columns: 1fr 1fr 80px; gap: 8px; margin-bottom: 10px; }
        .inp { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }

        .admin-list-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; border-bottom: 1px solid #eee; font-weight: 600;
        }

        /* CALENDAR */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 10px; }
        .cal-head { font-size: 0.75rem; font-weight: 800; color: #7f8c8d; }
        .cal-day {
            aspect-ratio: 1; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 0.85rem; cursor: pointer; background: white; border: 1px solid #e0e0e0;
        }
        .cal-day.sunday { background: var(--sunday-bg); color: #c0392b; border: 1px solid #e6b0aa; }
        .cal-day.has-data { background: #b9f6ca; color: #1b5e20; border: 2px solid var(--brand); }
        .cal-day.error { border: 2px solid red; background: #ffebee; }
        .cal-day.today { border: 2px solid var(--dark); }
        .cal-day.selected { transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.2); border: 2px solid var(--brand); }

        /* LEGENDA */
        .legend-box { display: flex; gap: 10px; margin-bottom: 10px; background: #f4f6f8; padding: 10px; border-radius: 8px; justify-content: center;}
        .legend-item { font-size: 0.75rem; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; }

        .day-detail-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0; border-bottom: 1px solid #eee;
        }
        .stat-badge { font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; font-weight: bold; color: white; margin-left: 5px; }
        .bg-green { background: #2ecc71; }
        .bg-yellow { background: #f1c40f; color: #333; }
        .bg-red { background: #e74c3c; }

        .stop-confirm-box {
            background: white; padding: 20px; border-radius: 15px; margin-top: 20px; width: 100%; box-sizing: border-box;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1); border: 1px solid #eee; display: flex; flex-direction: column; align-items: center;
        }

        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:999; display:flex; justify-content:center; align-items:center; flex-direction:column; }
        .hidden { display: none !important; }
        
        @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }
    </style>
</head>
<body>

    <div class="backdrop"></div>

    <div id="loader" class="loader">
        <img src="Galabau-Victor-Logo.png" style="width:100%; max-width:500px; height:auto; object-fit:contain;">
    </div>

    <div id="main-screen" class="app-container">
        
        <div class="header-card">
            <img src="Galabau-Victor-Logo.png" class="logo-img">
            <div class="live-clock" id="clock-display">--:--</div>
            <div class="live-date" id="date-display">-- ----- 2025</div>
        </div>

        <div class="weather-card">
            <div>
                <div class="w-msg" id="smart-greet">Salut!</div>
                <div class="w-sub" id="smart-sub">Se Ã®ncarcÄƒ meteo...</div>
            </div>
            <div class="w-temp" id="w-temp">--Â°</div>
        </div>

        <div class="avizier-section">
            <div class="avizier-label" id="avizier-label-text">ğŸ“‹ DISPOZIÈšII VICTOR</div>
            <div id="teams-container"></div>
        </div>

        <div id="setup-panel" class="glass-panel">
            <h3 style="margin:0 0 15px 0; color:#333;">SelecteazÄƒ Numele:</h3>
            <div class="worker-grid" id="main-worker-list"></div>

            <div style="width:100%; margin-top:20px; text-align:left;">
                <label style="font-weight:bold; font-size:0.9rem; color:#555;">ğŸ“ SelecteazÄƒ È˜antierul:</label>
                <select id="site-selector" class="site-select">
                    <option value="" disabled selected>-- Alege È˜antier --</option>
                </select>
            </div>

            <div class="loc-auto">
                <span style="font-size:1.5rem;">ğŸ“¡</span>
                <div class="loc-txt" id="loc-status">LocaÈ›ie AutomatÄƒ</div>
            </div>

            <button class="btn btn-start" onclick="initStart()">ğŸš€ START MUNCÄ‚</button>
        </div>

        <div id="active-panel" class="active-panel hidden">
            <h2 id="active-user" style="margin:0;">Angajat</h2>
            <p id="active-site" style="font-weight:800; color:var(--brand); margin:5px 0;">È˜antier</p>
            <p id="active-loc" style="color:#666; font-size:0.8rem;">LocaÈ›ie GPS</p>
            
            <div style="margin:30px 0;">
                <div id="status-badge" class="status-badge">ACTIV</div>
                <div class="timer-val" id="timer-val">0h 0m</div>
                <div style="margin-top:10px; font-weight:600; color:#555;">PauzÄƒ totalÄƒ: <span id="pause-val">0m</span></div>
            </div>

            <div id="work-controls" style="width:100%">
                <button class="btn btn-pause" id="btn-pause" onclick="togglePause()">â˜• PAUZÄ‚</button>
                <button class="btn btn-stop" onclick="showStopConfirm()">â¹ STOP ZI</button>
            </div>

            <div id="stop-confirm-box" class="stop-confirm-box hidden">
                <h3 style="margin-top:0;">DoreÈ™ti sÄƒ faci o pozÄƒ?</h3>
                <input type="file" id="photo-input" accept="image/*" capture="environment" style="display:none;" onchange="handlePhotoUpload(this)">
                <button class="btn btn-photo" onclick="document.getElementById('photo-input').click()">ğŸ“· DA, FÄ‚ POZÄ‚</button>
                <div id="photo-status" style="font-size:0.8rem; color:#27ae60; margin-top:5px; display:none; font-weight:bold;">Imagine AtaÈ™atÄƒ! âœ…</div>
                <button class="btn btn-stop" style="background:#7f8c8d; margin-top:10px;" onclick="finalizeStop(false)">OMITE (FÄ‚RÄ‚ POZÄ‚)</button>
            </div>
        </div>

        <div class="admin-trigger" onclick="openAdmin()">âš™ï¸ Admin</div>
    </div>

    <div id="admin-screen">
        <div class="admin-header">
            <span style="font-weight:900; letter-spacing:1px;">ADMINISTRAÈšIE</span>
            <button onclick="closeAdmin()" style="background:none; border:none; color:white; font-size:1.5rem;">âœ•</button>
        </div>

        <div style="padding:20px;">
            
            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">ğŸ‘¥ GestioneazÄƒ Echipa</h4>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="new-worker-name" class="inp" placeholder="Nume nou" style="width:70%;">
                    <button class="btn-add" onclick="addNewWorker()">AdaugÄƒ</button>
                </div>
                <div id="admin-worker-list-container"></div>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">ğŸ—ï¸ GestioneazÄƒ È˜antiere</h4>
                <div style="display:flex; gap:5px; margin-bottom:15px;">
                    <input type="text" id="new-site-name" class="inp" placeholder="Nume È˜antier" style="width:70%;">
                    <button class="btn-add" onclick="addNewSite()">AdaugÄƒ</button>
                </div>
                <div id="admin-site-list-container"></div>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">ğŸ“ Organizare & Avizier</h4>
                <div style="margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid #eee;">
                    <label style="font-size:0.8rem; font-weight:bold;">Data DispoziÈ›ie (ex: 06 Dec):</label>
                    <input class="inp" type="text" id="avizier-date-input" placeholder="Scrie data...">
                </div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm1-n" placeholder="Echipa 1"><input class="inp" type="text" id="tm1-l" placeholder="LocaÈ›ie"><input class="inp" type="text" id="tm1-t" placeholder="07:30"></div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm2-n" placeholder="Echipa 2"><input class="inp" type="text" id="tm2-l" placeholder="LocaÈ›ie"><input class="inp" type="text" id="tm2-t" placeholder="Ora"></div>
                <div class="team-edit-row"><input class="inp" type="text" id="tm3-n" placeholder="Echipa 3"><input class="inp" type="text" id="tm3-l" placeholder="LocaÈ›ie"><input class="inp" type="text" id="tm3-t" placeholder="Ora"></div>
                <button onclick="saveTeams()" style="width:100%; background:var(--brand); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold;">ActualizeazÄƒ</button>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 10px 0;">ğŸ—ºï¸ PoziÈ›ii Live</h4>
                <div id="map" style="height:250px; width:100%; border-radius:10px; border:1px solid #ccc;"></div>
                <button onclick="refreshMap()" style="width:100%; padding:10px; margin-top:10px; border:1px solid #ccc; background:#f9f9f9; border-radius:8px;">ğŸ”„ Actualizare</button>
            </div>

            <div class="admin-card">
                <div class="legend-box">
                    <div class="legend-item"><div class="dot bg-green"></div> MuncÄƒ</div>
                    <div class="legend-item"><div class="dot bg-yellow"></div> PauzÄƒ</div>
                    <div class="legend-item"><div class="dot bg-red"></div> Eroare</div>
                </div>

                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:15px;">
                    <span onclick="changeMonth(-1)" style="cursor:pointer; padding:5px;">â—€</span>
                    <span id="cal-month">Luna</span>
                    <span onclick="changeMonth(1)" style="cursor:pointer; padding:5px;">â–¶</span>
                </div>
                <div class="cal-grid">
                    <div class="cal-head">Lu</div><div class="cal-head">Ma</div><div class="cal-head">Mi</div>
                    <div class="cal-head">Jo</div><div class="cal-head">Vi</div><div class="cal-head">SÃ¢</div><div class="cal-head" style="color:var(--danger)">Du</div>
                </div>
                <div class="cal-grid" id="cal-body"></div>
                
                <div id="day-detail-box" style="margin-top:20px; border-top:2px solid #f4f4f4; padding-top:15px; display:none;">
                    <h4 id="detail-title" style="margin:0 0 10px 0; color:var(--brand);">Activitate</h4>
                    <div id="detail-list"></div>
                </div>
            </div>

            <div class="admin-card">
                <h4 style="margin:0 0 15px 0;">ğŸ“Š Raport Financiar</h4>
                <div style="display:flex; gap:10px;">
                    <button onclick="toggleStats()" style="width:100%; background:var(--admin-bg); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold;">Vezi Sumar</button>
                    <button onclick="generateDetailedPDF()" class="btn-pdf">ğŸ“„ DescarcÄƒ PDF</button>
                </div>
                <div id="stats-panel" class="hidden" style="margin-top:15px; border-top:1px dashed #ccc; padding-top:10px;">
                    <div style="font-weight:bold; color:var(--brand); margin-bottom:5px;">PE ANGAJAÈšI:</div>
                    <div id="stats-list"></div>
                    <div style="font-weight:bold; color:var(--brand); margin-top:15px; margin-bottom:5px;">PE È˜ANTIERE:</div>
                    <div id="site-stats-list"></div>
                </div>
            </div>

        </div>
    </div>

    <img id="logo-for-pdf" src="Galabau-Victor-Logo.png" style="display:none;">

    <script>
        // 1. CONFIGURARE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCoWS4CDB-xATg3ZsWhuaBzVvjeCGrL4X4",
            authDomain: "galabau-victor.firebaseapp.com",
            projectId: "galabau-victor",
            storageBucket: "galabau-victor.firebasestorage.app",
            messagingSenderId: "505659442402",
            appId: "1:505659442402:web:65278af4b272fd3c618abb",
            measurementId: "G-5TT0XW4ZDY"
        };
        
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            db.enablePersistence().catch(()=>{});
            window.db = db;
        } catch(e) { console.log(e); }

        // 2. STATE
        let app = { user: null, site: null, startT: 0, isPaused: false, pauseStartT: 0, totalPause: 0, docId: null, locName: "GPS", photoBase64: null };
        let timerInt, mapInst, mapMarkers=[], viewDate=new Date();

        function cleanText(str) {
            if(!str) return "";
            const map = {'Äƒ':'a','Ã¢':'a','Ã®':'i','È™':'s','È›':'t','Ä‚':'A','Ã‚':'A','Ã':'I','È˜':'S','Èš':'T'};
            return str.replace(/[ÄƒÃ¢Ã®È™È›Ä‚Ã‚ÃÈ˜Èš]/g, function(m) { return map[m]; });
        }

        const msgs = {
            m: ["NeaÈ›a! Cafeaua È™i la muncÄƒ! â˜•", "Start Ã®n forÈ›Äƒ azi! ğŸš€", "O zi productivÄƒ! ğŸ”¨", "SÄƒ meargÄƒ treaba strunÄƒ! ğŸ’ª"],
            n: ["PoftÄƒ mare la masÄƒ! ğŸ¥ª", "Hai cÄƒ mai e puÈ›in! â˜€ï¸", "Zi spornicÄƒ Ã®n continuare!", "TrageÈ›i tare! ğŸšœ", "Mai e un pic! â³"],
            e: ["SearÄƒ liniÈ™titÄƒ! ğŸŒ™", "OdihnÄƒ plÄƒcutÄƒ! ğŸ ", "Bravo pentru azi! âœ…", "MeritaÈ›i o bere! ğŸº"],
            cold: ["âš ï¸ E frig! LuaÈ›i haine groase!", "â„ï¸ MiÈ™carea È›ine de cald!"],
            hot: ["ğŸ”¥ E caniculÄƒ! HidrataÈ›i-vÄƒ!", "â˜€ï¸ È˜apca pe cap! Soare puternic!"],
            rain: ["ğŸŒ§ï¸ AtenÈ›ie la ploaie!", "â˜” AveÈ›i grijÄƒ la noroi!"]
        };

        // AUTO-CLEANUP
        async function checkAndCloseOldShifts() {
            const yesterday = new Date(); yesterday.setHours(0,0,0,0);
            const snaps = await window.db.collection('pontaje_final_v1').where('status', 'in', ['activ', 'pauza']).where('start', '<', firebase.firestore.Timestamp.fromDate(yesterday)).get();
            if(!snaps.empty) {
                snaps.forEach(doc => {
                    const forceStop = new Date(doc.data().start.toDate()); forceStop.setHours(23, 59, 59);
                    window.db.collection('pontaje_final_v1').doc(doc.id).update({status: 'eroare_neinchis', stop: firebase.firestore.Timestamp.fromDate(forceStop), ore: 0});
                });
            }
        }

        // STARTUP
        window.onload = () => {
            initClock();
            loadTeams();
            loadWorkers();
            loadSites();
            checkAndCloseOldShifts();
            
            const saved = localStorage.getItem('vt_v35');
            if(saved) {
                const s = JSON.parse(saved);
                const today = new Date().toLocaleDateString('ro-RO');
                const sessionDay = new Date(s.startT).toLocaleDateString('ro-RO');
                if(today !== sessionDay) forceClose(s);
                else { app = s; restoreUI(); }
            }
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 1500);
        };

        function initClock() {
            setInterval(()=>{
                const now = new Date();
                document.getElementById('clock-display').innerText = now.toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'});
                const months = ["IANUARIE","FEBRUARIE","MARTIE","APRILIE","MAI","IUNIE","IULIE","AUGUST","SEPTEMBRIE","OCTOMBRIE","NOIEMBRIE","DECEMBRIE"];
                document.getElementById('date-display').innerText = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
            }, 1000);

            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async p => {
                    try {
                        const r = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${p.coords.latitude}&longitude=${p.coords.longitude}&current_weather=true`);
                        const d = await r.json();
                        const t = Math.round(d.current_weather.temperature);
                        document.getElementById('w-temp').innerText = t+"Â°";
                        
                        const h = new Date().getHours();
                        let mainMsg = h < 12 ? msgs.m[0] : (h < 18 ? msgs.n[0] : msgs.e[0]);
                        let subMsg = "Vreme bunÄƒ.";
                        if(t < 5) subMsg = msgs.cold[0]; else if(t > 28) subMsg = msgs.hot[0];
                        document.getElementById('smart-greet').innerText = mainMsg;
                        document.getElementById('smart-sub').innerText = subMsg;
                    } catch(e){}
                });
            }
        }

        // --- MANAGEMENT WORKERS ---
        async function loadWorkers() {
            const doc = await window.db.collection('settings').doc('workers_final').get();
            let workers = ["Sandu", "Nicu", "Vadim", "Sorin", "Fani", "Ovidiu"]; 
            if(doc.exists && doc.data().list) workers = doc.data().list;
            else window.db.collection('settings').doc('workers_final').set({list: workers});
            
            const grid = document.getElementById('main-worker-list');
            grid.innerHTML = "";
            workers.forEach(name => {
                grid.innerHTML += `<div class="worker-item" onclick="selectUser(this, '${name}')"><span class="w-emoji">ğŸ‘·â€â™‚ï¸</span><span class="w-label">${name}</span></div>`;
            });

            const admList = document.getElementById('admin-worker-list-container');
            admList.innerHTML = "";
            workers.forEach(name => {
                admList.innerHTML += `<div class="admin-list-row"><span>ğŸ‘·â€â™‚ï¸ ${name}</span><button class="btn-small-del" onclick="deleteWorker('${name}')">È˜terge</button></div>`;
            });
        }
        async function addNewWorker() {
            const name = document.getElementById('new-worker-name').value;
            if(!name) return;
            const doc = await window.db.collection('settings').doc('workers_final').get();
            let list = doc.exists ? doc.data().list : [];
            list.push(name);
            await window.db.collection('settings').doc('workers_final').set({list: list}, {merge:true});
            document.getElementById('new-worker-name').value="";
            loadWorkers();
        }
        async function deleteWorker(name) {
            if(!confirm("È˜tergi?")) return;
            const doc = await window.db.collection('settings').doc('workers_final').get();
            let list = doc.data().list.filter(w => w !== name);
            await window.db.collection('settings').doc('workers_final').update({list: list});
            loadWorkers();
        }

        // --- MANAGEMENT SITES ---
        async function loadSites() {
            const doc = await window.db.collection('settings').doc('sites_v32').get();
            let sites = [];
            if(doc.exists && doc.data().list) sites = doc.data().list;
            
            const sel = document.getElementById('site-selector');
            sel.innerHTML = `<option value="" disabled selected>-- Alege È˜antier --</option>`;
            sites.forEach(s => {
                sel.innerHTML += `<option value="${s}">${s}</option>`;
            });

            const admList = document.getElementById('admin-site-list-container');
            admList.innerHTML = "";
            sites.forEach(s => {
                admList.innerHTML += `<div class="admin-list-row"><span>ğŸ—ï¸ ${s}</span><button class="btn-small-del" onclick="deleteSite('${s}')">È˜terge</button></div>`;
            });
        }
        async function addNewSite() {
            const name = document.getElementById('new-site-name').value;
            if(!name) return;
            const doc = await window.db.collection('settings').doc('sites_v32').get();
            let list = doc.exists ? doc.data().list : [];
            list.push(name);
            await window.db.collection('settings').doc('sites_v32').set({list: list}, {merge:true});
            document.getElementById('new-site-name').value="";
            loadSites();
        }
        async function deleteSite(name) {
            if(!confirm("È˜tergi?")) return;
            const doc = await window.db.collection('settings').doc('sites_v32').get();
            let list = doc.data().list.filter(s => s !== name);
            await window.db.collection('settings').doc('sites_v32').update({list: list});
            loadSites();
        }

        // AVIZIER
        function loadTeams() {
            if(!window.db) return;
            window.db.collection('settings').doc('echipe_v10').onSnapshot(d => {
                const container = document.getElementById('teams-container');
                container.innerHTML = "";
                if(d.exists) {
                    const data = d.data();
                    if(data.data_avizier) document.getElementById('avizier-label-text').innerText = `ğŸ“‹ DISPOZIÈšII: ${data.data_avizier}`;
                    const teams = [data.t1, data.t2, data.t3].filter(t => t && t.nume);
                    if(teams.length === 0) container.innerHTML = "<div style='text-align:center;color:#999'>Nicio dispoziÈ›ie momentan.</div>";
                    teams.forEach((t, i) => {
                        container.innerHTML += `<div class="team-display-card t${i+1}"><div><div class="td-name">Echipa ${i+1}: ${t.nume}</div><div class="td-loc">ğŸ“ ${t.loc}</div></div><div class="td-time">ğŸ•’ ${t.ora}</div></div>`;
                    });
                }
            });
        }
        function saveTeams() {
            const data = {
                data_avizier: document.getElementById('avizier-date-input').value,
                t1: { nume: document.getElementById('tm1-n').value, loc: document.getElementById('tm1-l').value, ora: document.getElementById('tm1-t').value },
                t2: { nume: document.getElementById('tm2-n').value, loc: document.getElementById('tm2-l').value, ora: document.getElementById('tm2-t').value },
                t3: { nume: document.getElementById('tm3-n').value, loc: document.getElementById('tm3-l').value, ora: document.getElementById('tm3-t').value }
            };
            window.db.collection('settings').doc('echipe_v10').set(data, {merge:true});
            alert("âœ… Avizier actualizat!");
        }

        // WORKER
        function selectUser(el, name) {
            document.querySelectorAll('.worker-item').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected'); app.user = name;
        }

        function initStart() {
            if(!app.user) return alert("SelecteazÄƒ numele!");
            const siteVal = document.getElementById('site-selector').value;
            if(!siteVal) return alert("SelecteazÄƒ È˜antierul!");
            app.site = siteVal;

            document.getElementById('loc-status').innerText = "ğŸ“¡ Se cautÄƒ GPS...";
            if(!navigator.geolocation) return startShift("FÄƒrÄƒ GPS", 0, 0);

            navigator.geolocation.getCurrentPosition(async (pos) => {
                let loc = "LocaÈ›ie GPS";
                try {
                    const r = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${pos.coords.latitude}&longitude=${pos.coords.longitude}&localityLanguage=ro`);
                    const d = await r.json();
                    loc = d.locality || d.city || "Zona RuralÄƒ";
                } catch(e){}
                startShift(loc, pos.coords.latitude, pos.coords.longitude);
            }, ()=>startShift("Eroare GPS", 0, 0), {enableHighAccuracy:true});
        }

        async function startShift(loc, lat, lon) {
            const now = Date.now();
            app.startT = now; app.locName = loc; app.totalPause = 0; app.isPaused = false; app.photoBase64 = null;

            const doc = await window.db.collection('pontaje_final_v1').add({
                nume: app.user, santier: app.site, locatie: loc, lat: lat, lon: lon,
                start: firebase.firestore.Timestamp.fromMillis(now),
                status: 'activ', luna: new Date().getMonth()+1, an: new Date().getFullYear(), zi: new Date().getDate()
            });
            app.docId = doc.id;
            saveLocal(); restoreUI();
        }

        function togglePause() {
            const now = Date.now();
            if(!app.isPaused) {
                app.isPaused = true; app.pauseStartT = now;
                window.db.collection('pontaje_final_v1').doc(app.docId).update({status: 'pauza'});
            } else {
                app.isPaused = false; app.totalPause += (now - app.pauseStartT); app.pauseStartT = 0;
                window.db.collection('pontaje_final_v1').doc(app.docId).update({status: 'activ'});
            }
            saveLocal(); restoreUI();
        }

        function showStopConfirm() {
            document.getElementById('work-controls').classList.add('hidden');
            document.getElementById('stop-confirm-box').classList.remove('hidden');
        }

        function handlePhotoUpload(input) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 800;
                        const scale = maxWidth / img.width;
                        canvas.width = maxWidth;
                        canvas.height = img.height * scale;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        app.photoBase64 = canvas.toDataURL('image/jpeg', 0.6);
                        document.getElementById('photo-status').style.display='block';
                        setTimeout(() => finalizeStop(true), 1500);
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(file);
            }
        }

        async function finalizeStop(hasPhoto) {
            const now = Date.now();
            let finalPause = app.totalPause;
            if(app.isPaused) finalPause += (now - app.pauseStartT);
            const hours = ((now - app.startT - finalPause) / 3600000).toFixed(2);

            let updateData = {
                stop: firebase.firestore.Timestamp.fromMillis(now),
                ore: parseFloat(hours), pauza_min: Math.round(finalPause/60000), status: 'finalizat'
            };
            if(hasPhoto && app.photoBase64) updateData.poza = app.photoBase64;

            await window.db.collection('pontaje_final_v1').doc(app.docId).update(updateData);
            localStorage.removeItem('vt_v35'); location.reload();
        }

        async function forceClose(s) {
            localStorage.removeItem('vt_v35'); location.reload();
        }

        function restoreUI() {
            document.getElementById('setup-panel').classList.add('hidden');
            document.getElementById('active-panel').classList.remove('hidden');
            document.getElementById('active-user').innerText = app.user;
            document.getElementById('active-loc').innerText = "ğŸ“ " + app.locName;
            document.getElementById('active-site').innerText = "ğŸ—ï¸ " + (app.site || "È˜antier");
            const btn = document.getElementById('btn-pause');
            const badge = document.getElementById('status-badge');
            if(app.isPaused) {
                btn.innerText = "â–¶ REIA MUNCA"; btn.className = "btn btn-start";
                badge.innerText = "ÃN PAUZÄ‚"; badge.className = "status-badge paused";
            } else {
                btn.innerText = "â˜• PAUZÄ‚"; btn.className = "btn btn-pause";
                badge.innerText = "ACTIV"; badge.className = "status-badge";
            }
            if(timerInt) clearInterval(timerInt);
            timerInt = setInterval(tick, 1000); tick();
        }

        function tick() {
            const now = Date.now();
            let workMs = app.isPaused ? (app.pauseStartT - app.startT - app.totalPause) : (now - app.startT - app.totalPause);
            let pauseMs = app.isPaused ? (app.totalPause + (now - app.pauseStartT)) : app.totalPause;
            document.getElementById('timer-val').innerText = formatHuman(workMs);
            document.getElementById('pause-val').innerText = Math.round(pauseMs/60000) + "m";
        }

        function saveLocal() { localStorage.setItem('vt_v35', JSON.stringify(app)); }

        // ADMIN
        function openAdmin() {
            if(prompt("Parola:")==="PASSAT") {
                document.getElementById('admin-screen').style.display='block';
                setTimeout(initMap, 500); renderCalendar();
                loadWorkers(); loadSites();
                checkAndCloseOldShifts();
            } else alert("GreÈ™it.");
        }
        function closeAdmin() { document.getElementById('admin-screen').style.display='none'; }

        function initMap() {
            if(!mapInst) {
                mapInst = L.map('map').setView([45.65, 25.60], 9);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInst);
            }
            setTimeout(() => mapInst.invalidateSize(), 300);
            refreshMap();
        }
        function refreshMap() {
            mapMarkers.forEach(m => mapInst.removeLayer(m)); mapMarkers=[];
            window.db.collection('pontaje_final_v1').where('status','in',['activ','pauza']).get().then(snaps => {
                const group = new L.featureGroup();
                snaps.forEach(doc => {
                    const d = doc.data();
                    let st = d.status==='activ' ? 'MunceÈ™te' : (d.status==='pauza' ? 'Ãn PauzÄƒ' : 'Activ');
                    if(d.lat) {
                        const m = L.marker([d.lat, d.lon])
                            .bindTooltip(`${d.nume} (${st}) @ ${d.santier||'?'}`, {permanent:true, direction:'right', className:'map-label'})
                            .addTo(mapInst);
                        mapMarkers.push(m); group.addLayer(m);
                    }
                });
                if(mapMarkers.length>0) mapInst.fitBounds(group.getBounds().pad(0.2));
            });
        }

        function changeMonth(d) { viewDate.setMonth(viewDate.getMonth()+d); renderCalendar(); }
        
        async function renderCalendar() {
            const grid = document.getElementById('cal-body');
            grid.innerHTML = "Wait...";
            const y = viewDate.getFullYear(), m = viewDate.getMonth();
            const monthNames = ["IANUARIE","FEBRUARIE","MARTIE","APRILIE","MAI","IUNIE","IULIE","AUGUST","SEPTEMBRIE","OCTOMBRIE","NOIEMBRIE","DECEMBRIE"];
            document.getElementById('cal-month').innerText = `${monthNames[m]} ${y}`;

            const snaps = await window.db.collection('pontaje_final_v1').where('luna','==',m+1).where('an','==',y).get();
            let dataMap = {}, totals = {}, siteTotals = {};
            snaps.forEach(doc => {
                const d = doc.data();
                if(!dataMap[d.zi]) dataMap[d.zi] = [];
                dataMap[d.zi].push(d);
                if(d.ore) { 
                    if(!totals[d.nume]) totals[d.nume] = 0; totals[d.nume] += d.ore; 
                    let s = d.santier || "Nespecificat";
                    if(!siteTotals[s]) siteTotals[s] = 0; siteTotals[s] += d.ore;
                }
            });
            window.monthlyTotals = totals; window.siteTotals = siteTotals; window.monthData = dataMap;

            const daysInMonth = new Date(y, m+1, 0).getDate();
            const startDay = new Date(y, m, 1).getDay(); 
            const pad = startDay === 0 ? 6 : startDay - 1;

            grid.innerHTML = "";
            for(let i=0; i<pad; i++) grid.innerHTML += `<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const date = new Date(y, m, d);
                let cls = 'cal-day';
                let content = d;
                if(date.getDay() === 0) { 
                    cls += ' sunday';
                    content = `${d}`;
                } else if(dataMap[d]) {
                    const hasErr = dataMap[d].some(x=>x.status==='eroare_neinchis');
                    cls += hasErr ? ' error' : ' has-data';
                }
                if(d===new Date().getDate() && m===new Date().getMonth()) cls += ' today';
                grid.innerHTML += `<div class="${cls}" onclick="showDetails(this, ${d})">${content}</div>`;
            }
        }

        function showDetails(el, d) {
            document.querySelectorAll('.cal-day').forEach(c=>c.classList.remove('selected'));
            el.classList.add('selected');
            const box = document.getElementById('day-detail-box');
            const list = document.getElementById('detail-list');
            box.style.display = 'block';
            
            const monthNames = ["IANUARIE","FEBRUARIE","MARTIE","APRILIE","MAI","IUNIE","IULIE","AUGUST","SEPTEMBRIE","OCTOMBRIE","NOIEMBRIE","DECEMBRIE"];
            document.getElementById('detail-title').innerText = `Activitate: ${d} ${monthNames[viewDate.getMonth()]}`;
            
            const checkDate = new Date(viewDate.getFullYear(), viewDate.getMonth(), d);
            if(checkDate.getDay() === 0) { list.innerHTML = "<div style='color:#c0392b; font-weight:bold; text-align:center;'>o zi liberÄƒ, doar pentru grÄƒtar ğŸ–</div>"; return; }

            const data = window.monthData[d];
            if(!data) { list.innerHTML = "FÄƒrÄƒ activitate."; return; }

            list.innerHTML = "";
            data.forEach(item => {
                let status = item.status==='activ'?'ğŸŸ¢ MunceÈ™te': (item.status==='pauza'?'ğŸŸ¡ Ãn PauzÄƒ' : formatHuman(item.ore*3600000));
                let pauza = item.pauza_min ? `${item.pauza_min}m` : '0m';
                let photoHtml = item.poza ? `<br><a href="${item.poza}" download="poza.jpg" style="font-size:0.7rem; color:blue">ğŸ“· Vezi PozÄƒ</a>` : '';
                if(item.status==='eroare_neinchis') status = `<span style="color:red">âš ï¸ Eroare</span>`;
                
                list.innerHTML += `
                    <div class="day-detail-item">
                        <div><strong>${item.nume}</strong> <small>(${item.santier||'Nespecificat'})</small><br><small style="color:#777">${item.locatie}</small>${photoHtml}</div>
                        <div style="text-align:right">
                            <span class="stat-badge ${item.status==='activ'?'bg-green':(item.status==='pauza'?'bg-yellow':'bg-green')}">${status}</span>
                            <span class="stat-badge bg-yellow">${pauza}</span>
                        </div>
                    </div>`;
            });
        }

        function toggleStats() {
            const panel = document.getElementById('stats-panel');
            const list = document.getElementById('stats-list');
            const siteList = document.getElementById('site-stats-list');
            panel.classList.toggle('hidden');
            
            if(!panel.classList.contains('hidden')) {
                // Workers
                list.innerHTML = "";
                const sortedW = Object.keys(window.monthlyTotals || {}).sort((a,b) => window.monthlyTotals[b] - window.monthlyTotals[a]);
                sortedW.forEach(n => {
                    list.innerHTML += `<div style="padding:5px 0; border-bottom:1px dashed #ccc; display:flex; justify-content:space-between;"><b>${n}</b> <span>${formatHuman(window.monthlyTotals[n]*3600000)}</span></div>`;
                });

                // Sites
                siteList.innerHTML = "";
                const sortedS = Object.keys(window.siteTotals || {}).sort((a,b) => window.siteTotals[b] - window.siteTotals[a]);
                sortedS.forEach(s => {
                    siteList.innerHTML += `<div style="padding:5px 0; border-bottom:1px dashed #ccc; display:flex; justify-content:space-between;"><b>${s}</b> <span>${formatHuman(window.siteTotals[s]*3600000)}</span></div>`;
                });
            }
        }

        async function generateDetailedPDF() {
            if(!window.jspdf) return alert("Eroare PDF");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const monthName = document.getElementById('cal-month').innerText;
            
            // LOGO
            const logo = document.getElementById('logo-for-pdf');
            if(logo && logo.src) {
                try {
                    const canvas = document.createElement("canvas");
                    canvas.width = logo.naturalWidth;
                    canvas.height = logo.naturalHeight;
                    const ctx = canvas.getContext("2d");
                    ctx.drawImage(logo, 0, 0);
                    const logoData = canvas.toDataURL("image/png");
                    doc.addImage(logoData, 'PNG', 90, 10, 30, 30 * (logo.naturalHeight/logo.naturalWidth)); 
                } catch(e){}
            }

            doc.setFontSize(18); doc.setTextColor(0, 148, 50);
            // Title Centered
            doc.text(`RAPORT LUNAR - ${monthName}`, 105, 50, { align: 'center' });
            doc.setFontSize(12); doc.setTextColor(0,0,0);
            doc.text("GalaBau Victor", 105, 57, { align: 'center' });
            
            let yPos = 70;

            const y = viewDate.getFullYear();
            const m = viewDate.getMonth() + 1;
            const snaps = await window.db.collection('pontaje_final_v1').where('luna','==',m).where('an','==',y).get();
            
            if(snaps.empty) return alert("Nu sunt date.");

            let rawDocs = [];
            snaps.forEach(doc => rawDocs.push(doc.data()));
            // SORTARE CRONOLOGICA
            rawDocs.sort((a, b) => a.start.seconds - b.start.seconds);

            let report = {}, siteReport = {};
            
            rawDocs.forEach(d => {
                if(!report[d.nume]) report[d.nume] = [];
                const start = d.start.toDate().toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'});
                const end = d.stop ? d.stop.toDate().toLocaleTimeString('ro-RO', {hour:'2-digit', minute:'2-digit'}) : "Activ";
                let s = d.santier || "Nespecificat";
                
                // Calcul Ore exacte
                let hoursVal = 0;
                if(d.ore) hoursVal = d.ore;
                
                report[d.nume].push({
                    row: [`${d.zi}/${d.luna}`, cleanText(s), cleanText(d.locatie), `${start}-${end}`, formatHuman(hoursVal*3600000)],
                    val: hoursVal
                });
                
                if(d.ore) {
                    if(!siteReport[s]) siteReport[s] = 0;
                    siteReport[s] += d.ore;
                }
            });

            // TABLE 1: Angajati
            Object.keys(report).forEach(name => {
                // Check if page break needed
                if(yPos > 250) { doc.addPage(); yPos = 20; }
                
                doc.setFontSize(14); doc.setTextColor(0, 148, 50);
                doc.text(`Angajat: ${name}`, 14, yPos);
                yPos += 6;

                // Prepare rows
                let rows = report[name].map(r => r.row);
                let totalH = report[name].reduce((acc, curr) => acc + curr.val, 0);

                doc.autoTable({
                    startY: yPos,
                    head: [['Data', 'Santier', 'Locatie', 'Interval', 'Ore']],
                    body: rows,
                    theme: 'grid',
                    styles: { halign: 'center' }, // CENTRARE GENERALA
                    headStyles: { halign: 'center', fillColor: [0, 148, 50] }, // VERDE
                    // TOTAL ROW
                    foot: [['', '', '', 'TOTAL LUNAR:', formatHuman(totalH * 3600000)]],
                    footStyles: { fillColor: [240, 240, 240], textColor: [0,0,0], fontStyle: 'bold', halign: 'center' }
                });
                yPos = doc.lastAutoTable.finalY + 15;
            });

            // TABLE 2: SANTIERE
            doc.addPage();
            yPos = 20;
            doc.setFontSize(18); doc.setTextColor(0, 148, 50);
            doc.text("TOTAL ORE PER SANTIER", 105, yPos, { align: 'center' });
            yPos += 15;
            
            let siteRows = [];
            Object.keys(siteReport).forEach(s => {
                siteRows.push([cleanText(s), formatHuman(siteReport[s]*3600000)]);
            });
            
            doc.autoTable({
                startY: yPos,
                head: [['Nume Santier', 'Total Ore']],
                body: siteRows,
                theme: 'striped',
                styles: { halign: 'center' },
                headStyles: { fillColor: [44, 62, 80], halign: 'center' }
            });

            doc.save(`Raport_GalaBau_${monthName}.pdf`);
        }

        function formatHuman(ms) {
            let h = Math.floor(ms/3600000); let m = Math.floor((ms%3600000)/60000);
            return `${h}h ${m}m`;
        }
    </script>
</body>
</html>
